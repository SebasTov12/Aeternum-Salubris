// Traducciones
const Translations = {
    es: {
        // General
        welcome: 'Bienvenido a',
        brand: 'Aeternum Salubris',
        subtitle: 'Tu sistema de gesti√≥n y seguimiento sanitario',
        begin: 'Comenzar',
        login: 'Iniciar Sesi√≥n',
        signup: 'Registrarse',
        logout: 'Salir',
        profile: 'Perfil',
        notifications: 'Notificaciones',
        search: 'B√∫squeda global',
        newTramite: 'Nuevo Tr√°mite',
        myCommerce: 'Mi Comercio',
        inspector: 'Inspector Sanitario',
        // Estados
        pending: 'Pendiente',
        inProcess: 'En Proceso',
        completed: 'Completado',
        rejected: 'Rechazado',
        // Dashboard
        totalActive: 'Total Activos',
        totalAssigned: 'Total Asignados',
        urgent: 'Urgentes',
        completedToday: 'Completados Hoy',
        averageTime: 'Tiempo Promedio',
        // Footer
        contact: 'Contacto',
        quickLinks: 'Enlaces R√°pidos',
        information: 'Informaci√≥n',
        privacyPolicy: 'Pol√≠tica de Privacidad',
        terms: 'T√©rminos y Condiciones',
        support: 'Soporte',
        allRightsReserved: 'Todos los derechos reservados',
        // Chatbot
        virtualAssistant: 'Asistente Virtual',
        online: 'En l√≠nea',
        helpPlaceholder: 'Escribe tu pregunta...',
        languageChanged: 'Idioma cambiado exitosamente',
        // Estados y m√°s
        all: 'Todos',
        allStates: 'Todos los estados',
        mostRecent: 'M√°s reciente',
        oldest: 'M√°s antiguo',
        byState: 'Por estado',
        byName: 'Por nombre',
        tracking: 'Seguimiento de Tr√°mites',
        // Formularios
        userType: 'Tipo de Usuario',
        selectUserType: 'Seleccione...',
        commerce: 'Comercio',
        email: 'Correo Electr√≥nico',
        emailPlaceholder: 'correo@ejemplo.com',
        password: 'Contrase√±a',
        passwordPlaceholder: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢',
        showPassword: 'Mostrar contrase√±a',
        rememberSession: 'Recordar sesi√≥n',
        fullName: 'Nombre Completo',
        namePlaceholder: 'Nombre del comercio o inspector',
        confirmPassword: 'Confirmar Contrase√±a',
        confirmPasswordPlaceholder: 'Repite la contrase√±a',
        phone: 'Tel√©fono de Contacto',
        phonePlaceholder: '+57 300 123 4567',
        address: 'Direcci√≥n',
        addressPlaceholder: 'Direcci√≥n del comercio',
        acceptTerms: 'Acepto los t√©rminos y condiciones',
        minPassword: 'M√≠nimo 6 caracteres',
        // Dashboard elementos
        seeAll: 'Ver todas',
        seeCalendar: 'Ver calendario',
        back: 'Volver',
        searchPlaceholder: 'Buscar por nombre, ID, direcci√≥n...',
        advancedSearch: 'B√∫squeda Avanzada',
        close: 'Cerrar',
        saveFilter: 'Guardar Filtro',
        filterNamePlaceholder: 'Nombre del filtro...',
        // Nuevo Tr√°mite
        commerceName: 'Nombre del Comercio',
        requestTramite: 'Solicitar Tr√°mite',
        // Estados y acciones
        view: 'Ver',
        edit: 'Editar',
        delete: 'Eliminar',
        download: 'Descargar',
        save: 'Guardar',
        cancel: 'Cancelar',
        filter: 'Filtrar',
        clear: 'Limpiar',
        // Estad√≠sticas
        total: 'Total',
        active: 'Activos',
        assigned: 'Asignados',
        rejected: 'Rechazados',
        averageTimeLabel: 'D√≠as para completar',
        distributionByState: 'Distribuci√≥n por Estado',
        monthlyTrend: 'Tendencia Mensual',
        byCommerceType: 'Tr√°mites por Tipo de Comercio',
        activitySummary: 'Resumen de Actividad',
        successRate: 'Tasa de √âxito',
        // Notificaciones
        noNotifications: 'No hay notificaciones',
        allNotifications: 'Todas las notificaciones',
        // Chatbot
        chatbotTitle: 'Asistente Virtual',
        chatbotOnline: 'En l√≠nea',
        chatbotPlaceholder: 'Escribe tu pregunta...',
        chatbotClose: 'Cerrar chat',
        // Footer
        home: 'Inicio',
        myProfile: 'Mi Perfil',
        help: 'Ayuda',
        // Sistema
        systemTitle: 'Sistema de Seguimiento y Trazabilidad',
        demoCredentials: 'Credenciales de prueba:',
        copy: 'Copiar',
        // Global Search
        globalSearchPlaceholder: 'Buscar tr√°mites, documentos, notificaciones...',
        writeToSearch: 'Escribe para buscar...',
        noResults: 'No se encontraron resultados',
        // Otros
        days: 'D√≠as',
        of: 'del',
        today: 'Hoy',
        yesterday: 'Ayer',
        loading: 'Cargando...',
        recent: 'Recientes',
        statistics: 'Estad√≠sticas',
        calendar: 'Calendario',
        applyFilters: 'Aplicar Filtros',
        clearFilters: 'Limpiar',
    },
    en: {
        // General
        welcome: 'Welcome to',
        brand: 'Aeternum Salubris',
        subtitle: 'Your health management and tracking system',
        begin: 'Begin',
        login: 'Sign In',
        signup: 'Sign Up',
        logout: 'Logout',
        profile: 'Profile',
        notifications: 'Notifications',
        search: 'Global Search',
        newTramite: 'New Procedure',
        myCommerce: 'My Commerce',
        inspector: 'Health Inspector',
        // Estados
        pending: 'Pending',
        inProcess: 'In Process',
        completed: 'Completed',
        rejected: 'Rejected',
        // Dashboard
        totalActive: 'Total Active',
        totalAssigned: 'Total Assigned',
        urgent: 'Urgent',
        completedToday: 'Completed Today',
        averageTime: 'Average Time',
        // Footer
        contact: 'Contact',
        quickLinks: 'Quick Links',
        information: 'Information',
        privacyPolicy: 'Privacy Policy',
        terms: 'Terms and Conditions',
        support: 'Support',
        allRightsReserved: 'All rights reserved',
        // Chatbot
        virtualAssistant: 'Virtual Assistant',
        online: 'Online',
        helpPlaceholder: 'Type your question...',
        languageChanged: 'Language changed successfully',
        all: 'All',
        allStates: 'All states',
        mostRecent: 'Most recent',
        oldest: 'Oldest',
        byState: 'By state',
        byName: 'By name',
        tracking: 'Procedure Tracking',
        // Formularios
        userType: 'User Type',
        selectUserType: 'Select...',
        commerce: 'Commerce',
        email: 'Email',
        emailPlaceholder: 'email@example.com',
        password: 'Password',
        passwordPlaceholder: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢',
        showPassword: 'Show password',
        rememberSession: 'Remember session',
        fullName: 'Full Name',
        namePlaceholder: 'Commerce or inspector name',
        confirmPassword: 'Confirm Password',
        confirmPasswordPlaceholder: 'Repeat password',
        phone: 'Contact Phone',
        phonePlaceholder: '+57 300 123 4567',
        address: 'Address',
        addressPlaceholder: 'Commerce address',
        acceptTerms: 'I accept the terms and conditions',
        minPassword: 'Minimum 6 characters',
        // Dashboard elementos
        seeAll: 'See all',
        seeCalendar: 'View calendar',
        back: 'Back',
        searchPlaceholder: 'Search by name, ID, address...',
        advancedSearch: 'Advanced Search',
        close: 'Close',
        saveFilter: 'Save Filter',
        filterNamePlaceholder: 'Filter name...',
        // Nuevo Tr√°mite
        commerceName: 'Commerce Name',
        requestTramite: 'Request Procedure',
        // Estados y acciones
        view: 'View',
        edit: 'Edit',
        delete: 'Delete',
        download: 'Download',
        save: 'Save',
        cancel: 'Cancel',
        filter: 'Filter',
        clear: 'Clear',
        // Estad√≠sticas
        total: 'Total',
        active: 'Active',
        assigned: 'Assigned',
        rejected: 'Rejected',
        averageTimeLabel: 'Days to complete',
        distributionByState: 'Distribution by State',
        monthlyTrend: 'Monthly Trend',
        byCommerceType: 'Procedures by Commerce Type',
        activitySummary: 'Activity Summary',
        successRate: 'Success Rate',
        // Notificaciones
        noNotifications: 'No notifications',
        allNotifications: 'All notifications',
        // Chatbot
        chatbotTitle: 'Virtual Assistant',
        chatbotOnline: 'Online',
        chatbotPlaceholder: 'Type your question...',
        chatbotClose: 'Close chat',
        // Footer
        home: 'Home',
        myProfile: 'My Profile',
        help: 'Help',
        // Sistema
        systemTitle: 'Tracking and Traceability System',
        demoCredentials: 'Test credentials:',
        copy: 'Copy',
        // Global Search
        globalSearchPlaceholder: 'Search procedures, documents, notifications...',
        writeToSearch: 'Type to search...',
        noResults: 'No results found',
        // Otros
        days: 'Days',
        of: 'of',
        today: 'Today',
        yesterday: 'Yesterday',
        loading: 'Loading...',
        recent: 'Recent',
        statistics: 'Statistics',
        calendar: 'Calendar',
        applyFilters: 'Apply Filters',
        clearFilters: 'Clear',
    },
    fr: {
        // General
        welcome: 'Bienvenue √†',
        brand: 'Aeternum Salubris',
        subtitle: 'Votre syst√®me de gestion et de suivi sanitaire',
        begin: 'Commencer',
        login: 'Se connecter',
        signup: 'S\'inscrire',
        logout: 'D√©connexion',
        profile: 'Profil',
        notifications: 'Notifications',
        search: 'Recherche globale',
        newTramite: 'Nouvelle Proc√©dure',
        myCommerce: 'Mon Commerce',
        inspector: 'Inspecteur Sanitaire',
        // Estados
        pending: 'En attente',
        inProcess: 'En cours',
        completed: 'Termin√©',
        rejected: 'Rejet√©',
        // Dashboard
        totalActive: 'Total Actif',
        totalAssigned: 'Total Assign√©',
        urgent: 'Urgent',
        completedToday: 'Termin√© Aujourd\'hui',
        averageTime: 'Temps Moyen',
        // Footer
        contact: 'Contact',
        quickLinks: 'Liens Rapides',
        information: 'Information',
        privacyPolicy: 'Politique de Confidentialit√©',
        terms: 'Termes et Conditions',
        support: 'Support',
        allRightsReserved: 'Tous droits r√©serv√©s',
        // Chatbot
        virtualAssistant: 'Assistant Virtuel',
        online: 'En ligne',
        helpPlaceholder: 'Tapez votre question...',
        languageChanged: 'Langue chang√©e avec succ√®s',
        all: 'Tous',
        allStates: 'Tous les √©tats',
        mostRecent: 'Plus r√©cent',
        oldest: 'Plus ancien',
        byState: 'Par √©tat',
        byName: 'Par nom',
        tracking: 'Suivi des Proc√©dures',
        // Formularios
        userType: 'Type d\'utilisateur',
        selectUserType: 'S√©lectionnez...',
        commerce: 'Commerce',
        email: 'Adresse √©lectronique',
        emailPlaceholder: 'email@exemple.com',
        password: 'Mot de passe',
        passwordPlaceholder: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢',
        showPassword: 'Afficher le mot de passe',
        rememberSession: 'Se souvenir de la session',
        fullName: 'Nom complet',
        namePlaceholder: 'Nom du commerce ou de l\'inspecteur',
        confirmPassword: 'Confirmer le mot de passe',
        confirmPasswordPlaceholder: 'R√©p√©tez le mot de passe',
        phone: 'T√©l√©phone de contact',
        phonePlaceholder: '+57 300 123 4567',
        address: 'Adresse',
        addressPlaceholder: 'Adresse du commerce',
        acceptTerms: 'J\'accepte les termes et conditions',
        minPassword: 'Minimum 6 caract√®res',
        // Dashboard elementos
        seeAll: 'Voir tout',
        seeCalendar: 'Voir le calendrier',
        back: 'Retour',
        searchPlaceholder: 'Rechercher par nom, ID, adresse...',
        advancedSearch: 'Recherche avanc√©e',
        close: 'Fermer',
        saveFilter: 'Enregistrer le filtre',
        filterNamePlaceholder: 'Nom du filtre...',
        // Nuevo Tr√°mite
        commerceName: 'Nom du commerce',
        requestTramite: 'Demander une proc√©dure',
        // Estados y acciones
        view: 'Voir',
        edit: 'Modifier',
        delete: 'Supprimer',
        download: 'T√©l√©charger',
        save: 'Enregistrer',
        cancel: 'Annuler',
        filter: 'Filtrer',
        clear: 'Effacer',
        // Estad√≠sticas
        total: 'Total',
        active: 'Actif',
        assigned: 'Assign√©',
        rejected: 'Rejet√©',
        averageTimeLabel: 'Jours pour terminer',
        distributionByState: 'Distribution par √©tat',
        monthlyTrend: 'Tendance mensuelle',
        byCommerceType: 'Proc√©dures par type de commerce',
        activitySummary: 'R√©sum√© de l\'activit√©',
        successRate: 'Taux de succ√®s',
        // Notificaciones
        noNotifications: 'Aucune notification',
        allNotifications: 'Toutes les notifications',
        // Chatbot
        chatbotTitle: 'Assistant virtuel',
        chatbotOnline: 'En ligne',
        chatbotPlaceholder: 'Tapez votre question...',
        chatbotClose: 'Fermer le chat',
        // Footer
        home: 'Accueil',
        myProfile: 'Mon profil',
        help: 'Aide',
        // Sistema
        systemTitle: 'Syst√®me de suivi et de tra√ßabilit√©',
        demoCredentials: 'Identifiants de test:',
        copy: 'Copier',
        // Global Search
        globalSearchPlaceholder: 'Rechercher proc√©dures, documents, notifications...',
        writeToSearch: 'Tapez pour rechercher...',
        noResults: 'Aucun r√©sultat trouv√©',
        // Otros
        days: 'Jours',
        of: 'de',
        today: 'Aujourd\'hui',
        yesterday: 'Hier',
        loading: 'Chargement...',
        recent: 'R√©cent',
        statistics: 'Statistiques',
        calendar: 'Calendrier',
        applyFilters: 'Appliquer les filtres',
        clearFilters: 'Effacer',
    },
    pt: {
        // General
        welcome: 'Bem-vindo ao',
        brand: 'Aeternum Salubris',
        subtitle: 'Seu sistema de gest√£o e rastreamento sanit√°rio',
        begin: 'Come√ßar',
        login: 'Entrar',
        signup: 'Registrar',
        logout: 'Sair',
        profile: 'Perfil',
        notifications: 'Notifica√ß√µes',
        search: 'Busca Global',
        newTramite: 'Novo Tr√¢mite',
        myCommerce: 'Meu Com√©rcio',
        inspector: 'Inspetor Sanit√°rio',
        // Estados
        pending: 'Pendente',
        inProcess: 'Em Processo',
        completed: 'Conclu√≠do',
        rejected: 'Rejeitado',
        // Dashboard
        totalActive: 'Total Ativo',
        totalAssigned: 'Total Atribu√≠do',
        urgent: 'Urgente',
        completedToday: 'Conclu√≠do Hoje',
        averageTime: 'Tempo M√©dio',
        // Footer
        contact: 'Contato',
        quickLinks: 'Links R√°pidos',
        information: 'Informa√ß√£o',
        privacyPolicy: 'Pol√≠tica de Privacidade',
        terms: 'Termos e Condi√ß√µes',
        support: 'Suporte',
        allRightsReserved: 'Todos os direitos reservados',
        // Chatbot
        virtualAssistant: 'Assistente Virtual',
        online: 'Online',
        helpPlaceholder: 'Digite sua pergunta...',
        languageChanged: 'Idioma alterado com sucesso',
        all: 'Todos',
        allStates: 'Todos os estados',
        mostRecent: 'Mais recente',
        oldest: 'Mais antigo',
        byState: 'Por estado',
        byName: 'Por nome',
        tracking: 'Rastreamento de Tr√¢mites',
        // Formularios
        userType: 'Tipo de Usu√°rio',
        selectUserType: 'Selecione...',
        commerce: 'Com√©rcio',
        email: 'E-mail',
        emailPlaceholder: 'email@exemplo.com',
        password: 'Senha',
        passwordPlaceholder: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢',
        showPassword: 'Mostrar senha',
        rememberSession: 'Lembrar sess√£o',
        fullName: 'Nome Completo',
        namePlaceholder: 'Nome do com√©rcio ou inspetor',
        confirmPassword: 'Confirmar Senha',
        confirmPasswordPlaceholder: 'Repita a senha',
        phone: 'Telefone de Contato',
        phonePlaceholder: '+57 300 123 4567',
        address: 'Endere√ßo',
        addressPlaceholder: 'Endere√ßo do com√©rcio',
        acceptTerms: 'Aceito os termos e condi√ß√µes',
        minPassword: 'M√≠nimo 6 caracteres',
        // Dashboard elementos
        seeAll: 'Ver todos',
        seeCalendar: 'Ver calend√°rio',
        back: 'Voltar',
        searchPlaceholder: 'Buscar por nome, ID, endere√ßo...',
        advancedSearch: 'Busca Avan√ßada',
        close: 'Fechar',
        saveFilter: 'Salvar Filtro',
        filterNamePlaceholder: 'Nome do filtro...',
        // Nuevo Tr√°mite
        commerceName: 'Nome do Com√©rcio',
        requestTramite: 'Solicitar Tr√¢mite',
        // Estados y acciones
        view: 'Ver',
        edit: 'Editar',
        delete: 'Excluir',
        download: 'Baixar',
        save: 'Salvar',
        cancel: 'Cancelar',
        filter: 'Filtrar',
        clear: 'Limpar',
        // Estad√≠sticas
        total: 'Total',
        active: 'Ativos',
        assigned: 'Atribu√≠dos',
        rejected: 'Rejeitados',
        averageTimeLabel: 'Dias para completar',
        distributionByState: 'Distribui√ß√£o por Estado',
        monthlyTrend: 'Tend√™ncia Mensal',
        byCommerceType: 'Tr√¢mites por Tipo de Com√©rcio',
        activitySummary: 'Resumo de Atividade',
        successRate: 'Taxa de Sucesso',
        // Notificaciones
        noNotifications: 'Sem notifica√ß√µes',
        allNotifications: 'Todas as notifica√ß√µes',
        // Chatbot
        chatbotTitle: 'Assistente Virtual',
        chatbotOnline: 'Online',
        chatbotPlaceholder: 'Digite sua pergunta...',
        chatbotClose: 'Fechar chat',
        // Footer
        home: 'In√≠cio',
        myProfile: 'Meu Perfil',
        help: 'Ajuda',
        // Sistema
        systemTitle: 'Sistema de Rastreamento e Rastreabilidade',
        demoCredentials: 'Credenciais de teste:',
        copy: 'Copiar',
        // Global Search
        globalSearchPlaceholder: 'Buscar tr√¢mites, documentos, notifica√ß√µes...',
        writeToSearch: 'Digite para buscar...',
        noResults: 'Nenhum resultado encontrado',
        // Otros
        days: 'Dias',
        of: 'de',
        today: 'Hoje',
        yesterday: 'Ontem',
        loading: 'Carregando...',
        recent: 'Recentes',
        statistics: 'Estat√≠sticas',
        calendar: 'Calend√°rio',
        applyFilters: 'Aplicar Filtros',
        clearFilters: 'Limpar',
    }
};

// Estado de la aplicaci√≥n
const AppState = {
    currentUser: null,
    tramites: [],
    notifications: [],
    notificationFilter: 'all',
    currentTramiteChat: null,
    currentTramiteDocuments: null,
    currentPageComercio: 1,
    currentPageInspector: 1,
    itemsPerPage: 6,
    currentCalendarMonth: new Date().getMonth(),
    currentCalendarYear: new Date().getFullYear(),
    advancedFilters: {},
    savedFilters: [],
    globalSearchResults: [],
    currentLanguage: 'es',
    init() {
        this.loadLanguage();
        this.loadData();
        this.loadNotifications();
        this.loadSavedFilters();
        this.initTheme();
        this.setupWelcomeDarkMode();
        this.setupEventListeners();
        this.setupKeyboardShortcuts();
        this.setupMobileNavScroll();
        this.checkReminders();
        this.initServiceWorker();
        this.initPushNotifications();
        this.initChatbot();
        this.initLanguageSelector();
        this.applyLanguage();
    },
    
    setupWelcomeDarkMode() {
        // Forzar modo oscuro en la p√°gina de bienvenida
        const welcomeScreen = document.getElementById('welcomeScreen');
        if (welcomeScreen) {
            welcomeScreen.classList.add('welcome-dark-mode');
        }
    },
    
    setupMobileNavScroll() {
        // Detectar scroll en header-actions y agregar clase al header-content
        const headerContents = document.querySelectorAll('.header-content');
        
        headerContents.forEach(headerContent => {
            const actions = headerContent.querySelector('.header-actions');
            if (!actions) return;
            
            const checkScroll = () => {
                const hasScroll = actions.scrollWidth > actions.clientWidth;
                const isAtStart = actions.scrollLeft <= 1;
                const isAtEnd = actions.scrollWidth - actions.scrollLeft <= actions.clientWidth + 1;
                
                if (hasScroll) {
                    headerContent.classList.add('has-scrollable-nav');
                    
                    // Indicador de inicio
                    if (isAtStart) {
                        headerContent.classList.remove('has-scrolled-nav');
                    } else {
                        headerContent.classList.add('has-scrolled-nav');
                    }
                    
                    // Indicador de final
                    if (isAtEnd) {
                        headerContent.classList.remove('has-scrollable-nav');
                    }
                } else {
                    headerContent.classList.remove('has-scrollable-nav', 'has-scrolled-nav');
                }
            };
            
            // Verificar al cargar
            setTimeout(checkScroll, 100); // Delay para asegurar que el DOM est√° listo
            
            // Verificar al redimensionar
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(checkScroll, 100);
            });
            
            // Verificar scroll
            actions.addEventListener('scroll', () => {
                const isAtStart = actions.scrollLeft <= 1;
                const isAtEnd = actions.scrollWidth - actions.scrollLeft <= actions.clientWidth + 1;
                
                if (isAtStart) {
                    headerContent.classList.remove('has-scrolled-nav');
                } else {
                    headerContent.classList.add('has-scrolled-nav');
                }
                
                if (isAtEnd) {
                    headerContent.classList.remove('has-scrollable-nav');
                } else {
                    headerContent.classList.add('has-scrollable-nav');
                }
            });
        });
    },
    
    initTheme() {
        // Cargar tema guardado o usar el predeterminado
        const savedTheme = localStorage.getItem('theme') || 'light';
        this.setTheme(savedTheme);
    },
    
    // ========== SISTEMA DE IDIOMAS ==========
    loadLanguage() {
        const savedLang = localStorage.getItem('language') || 'es';
        this.currentLanguage = savedLang;
        document.documentElement.setAttribute('lang', savedLang);
    },
    
    saveLanguage() {
        localStorage.setItem('language', this.currentLanguage);
        document.documentElement.setAttribute('lang', this.currentLanguage);
    },
    
    setLanguage(lang) {
        if (Translations[lang]) {
            this.currentLanguage = lang;
            this.saveLanguage();
            this.applyLanguage();
            this.updateLanguageSelector();
            this.showNotification(this.t('languageChanged') || 'Idioma cambiado', 'success');
        }
    },
    
    t(key) {
        return Translations[this.currentLanguage]?.[key] || Translations['es'][key] || key;
    },
    
    initLanguageSelector() {
        const toggle = document.getElementById('languageToggle');
        const toggleInspector = document.getElementById('languageToggleInspector');
        const dropdown = document.getElementById('languageDropdown');
        const dropdownInspector = document.getElementById('languageDropdownInspector');
        
        // Toggle dropdown
        toggle?.addEventListener('click', (e) => {
            e.stopPropagation();
            dropdown?.classList.toggle('active');
        });
        
        toggleInspector?.addEventListener('click', (e) => {
            e.stopPropagation();
            dropdownInspector?.classList.toggle('active');
        });
        
        // Cerrar al hacer click fuera
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.language-selector')) {
                dropdown?.classList.remove('active');
                dropdownInspector?.classList.remove('active');
            }
        });
        
        // Seleccionar idioma
        document.querySelectorAll('.language-option').forEach(option => {
            option.addEventListener('click', () => {
                const lang = option.dataset.lang;
                this.setLanguage(lang);
                dropdown?.classList.remove('active');
                dropdownInspector?.classList.remove('active');
            });
        });
        
        this.updateLanguageSelector();
    },
    
    updateLanguageSelector() {
        const langCode = this.currentLanguage.toUpperCase();
        const langFlags = { es: 'üá™üá∏', en: 'üá∫üá∏', fr: 'üá´üá∑', pt: 'üáßüá∑' };
        
        document.querySelectorAll('.language-code').forEach(code => {
            code.textContent = langCode;
        });
        
        document.querySelectorAll('.language-flag').forEach(flag => {
            flag.textContent = langFlags[this.currentLanguage] || 'üåê';
        });
        
        document.querySelectorAll('.language-option').forEach(option => {
            option.classList.remove('active');
            if (option.dataset.lang === this.currentLanguage) {
                option.classList.add('active');
            }
        });
    },
    
    applyLanguage() {
        // Traducir elementos con data-i18n
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            const translation = this.t(key);
            if (translation) {
                if (el.tagName === 'INPUT' && el.type !== 'submit' && el.type !== 'button') {
                    el.placeholder = translation;
                } else if (el.tagName === 'OPTION') {
                    el.textContent = translation;
                } else {
                    el.textContent = translation;
                }
            }
        });
        
        // Traducir placeholders con data-i18n-placeholder
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            const key = el.getAttribute('data-i18n-placeholder');
            const translation = this.t(key);
            if (translation) {
                el.placeholder = translation;
            }
        });
        
        // Traducir aria-labels con data-i18n-aria-label
        document.querySelectorAll('[data-i18n-aria-label]').forEach(el => {
            const key = el.getAttribute('data-i18n-aria-label');
            const translation = this.t(key);
            if (translation) {
                el.setAttribute('aria-label', translation);
            }
        });
        
        // Actualizar t√≠tulos y textos principales
        this.updateMainTexts();
    },
    
    updateMainTexts() {
        // Bienvenida
        const welcomeTitle = document.querySelector('.welcome-title-main');
        const welcomeBrand = document.querySelector('.welcome-title-brand');
        const welcomeSubtitle = document.querySelector('.welcome-subtitle');
        const beginBtn = document.getElementById('goToLoginBtn');
        
        if (welcomeTitle) welcomeTitle.textContent = this.t('welcome');
        if (welcomeBrand) welcomeBrand.textContent = this.t('brand');
        if (welcomeSubtitle) welcomeSubtitle.textContent = this.t('subtitle');
        if (beginBtn) {
            const span = beginBtn.querySelector('span:first-child');
            if (span) span.textContent = this.t('begin');
        }
        
        // Headers
        const h1Comercio = document.querySelector('#comercioDashboard h1');
        const h1Inspector = document.querySelector('#inspectorDashboard h1');
        if (h1Comercio) h1Comercio.textContent = this.t('myCommerce');
        if (h1Inspector) h1Inspector.textContent = this.t('inspector');
        
        // Botones principales
        const nuevoTramiteBtn = document.getElementById('nuevoTramiteBtn');
        if (nuevoTramiteBtn) nuevoTramiteBtn.textContent = this.t('newTramite');
        
        // Actualizar textos de botones en headers
        document.querySelectorAll('.icon-text').forEach(iconText => {
            const text = iconText.textContent.trim();
            if (text.includes('Notificaciones')) {
                iconText.textContent = this.t('notifications');
            } else if (text.includes('Perfil')) {
                iconText.textContent = this.t('profile');
            }
        });
        
        const logoutBtns = document.querySelectorAll('.btn-logout');
        logoutBtns.forEach(btn => {
            if (btn.textContent.includes('Salir')) {
                btn.textContent = this.t('logout');
            }
        });
        
        // Footer
        const footerContact = document.querySelector('.footer-section h4');
        if (footerContact && footerContact.textContent.includes('Contacto')) {
            footerContact.textContent = this.t('contact');
        }
    },
    
    setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        this.updateThemeToggleButtons();
    },
    
    toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        this.setTheme(newTheme);
    },
    
    updateThemeToggleButtons() {
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
        const themeButtons = document.querySelectorAll('.theme-toggle');
        themeButtons.forEach(btn => {
            btn.textContent = currentTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
        });
    },
    
    loadData() {
        const savedTramites = localStorage.getItem('tramites');
        if (savedTramites) {
            this.tramites = JSON.parse(savedTramites);
        } else {
            // Datos de ejemplo
            this.tramites = [
                {
                    id: 'TRM-001',
                    comercioId: 'comercio@demo.com',
                    nombreComercio: 'Restaurante El Buen Sabor',
                    direccion: 'Calle 72 # 10-45, Bogot√°',
                    tipoComercio: 'restaurante',
                    telefono: '3001234567',
                    estado: 'en-proceso',
                    fechaCreacion: new Date('2024-11-01').toISOString(),
                    historial: [
                        {
                            etapa: 'Notificaci√≥n del Establecimiento',
                            fecha: new Date('2024-11-01').toISOString(),
                            descripcion: 'El comercio ha notificado su apertura o funcionamiento ante la Secretar√≠a de Salud',
                            inspector: null,
                            notas: 'Tr√°mite registrado en el sistema',
                            completado: true
                        },
                        {
                            etapa: 'Verificaci√≥n de Documentaci√≥n B√°sica',
                            fecha: new Date('2024-11-02').toISOString(),
                            descripcion: 'Revisi√≥n de documentos legales: Certificado de C√°mara de Comercio, RUT, Concepto de Uso de Suelo',
                            inspector: 'inspector@demo.com',
                            notas: 'Documentaci√≥n b√°sica verificada',
                            completado: true
                        },
                        {
                            etapa: 'Verificaci√≥n de Condiciones Sanitarias',
                            fecha: new Date('2024-11-03').toISOString(),
                            descripcion: 'Verificaci√≥n de limpieza, ventilaci√≥n, iluminaci√≥n, agua potable, control de plagas y manejo de residuos',
                            inspector: 'inspector@demo.com',
                            notas: 'Condiciones sanitarias verificadas',
                            completado: true
                        },
                        {
                            etapa: 'Verificaci√≥n de Buenas Pr√°cticas de Manufactura (BPM)',
                            fecha: new Date('2024-11-05').toISOString(),
                            descripcion: 'Verificaci√≥n de control de temperaturas, almacenamiento, manipulaci√≥n higi√©nica, equipos desinfectados y carn√© de salud de empleados',
                            inspector: 'inspector@demo.com',
                            notas: 'Se encontraron algunas √°reas de mejora en el almacenamiento de alimentos',
                            completado: true
                        },
                        {
                            etapa: 'Primera Visita de Inspecci√≥n Sanitaria',
                            fecha: null,
                            descripcion: 'Inspecci√≥n f√≠sica del establecimiento por inspector sanitario de la Secretar√≠a de Salud',
                            inspector: null,
                            notas: '',
                            completado: false
                        },
                        {
                            etapa: 'Revisi√≥n y Evaluaci√≥n',
                            fecha: null,
                            descripcion: 'Evaluaci√≥n del cumplimiento de normas sanitarias (Decreto 3075 de 1997 y Resoluci√≥n 2674 de 2013)',
                            inspector: null,
                            notas: '',
                            completado: false
                        },
                        {
                            etapa: 'Segunda Visita (Correcci√≥n de Requerimientos)',
                            fecha: null,
                            descripcion: 'Si hubo requerimientos, verificaci√≥n de correcciones realizadas por el establecimiento',
                            inspector: null,
                            notas: '',
                            completado: false
                        },
                        {
                            etapa: 'Emisi√≥n de Concepto Sanitario',
                            fecha: null,
                            descripcion: 'Emisi√≥n del resultado final: Favorable, Favorable con requerimientos, o Desfavorable',
                            inspector: null,
                            notas: '',
                            completado: false
                        }
                    ],
                    documentosRequeridos: this.getDocumentosRequeridos('restaurante'),
                    documentosSubidos: []
                },
                {
                    id: 'TRM-002',
                    comercioId: 'comercio@demo.com',
                    nombreComercio: 'Panader√≠a La Delicia',
                    direccion: 'Avenida 68 # 15-30, Bogot√°',
                    tipoComercio: 'panaderia',
                    telefono: '3009876543',
                    estado: 'pendiente',
                    fechaCreacion: new Date('2024-11-03').toISOString(),
                    historial: [
                        {
                            etapa: 'Notificaci√≥n del Establecimiento',
                            fecha: new Date('2024-11-03').toISOString(),
                            descripcion: 'El comercio ha notificado su apertura o funcionamiento ante la Secretar√≠a de Salud',
                            inspector: null,
                            notas: 'Tr√°mite registrado en el sistema',
                            completado: true
                        },
                        {
                            etapa: 'Verificaci√≥n de Documentaci√≥n B√°sica',
                            fecha: null,
                            descripcion: 'Revisi√≥n de documentos legales: Certificado de C√°mara de Comercio, RUT, Concepto de Uso de Suelo',
                            inspector: null,
                            notas: '',
                            completado: false
                        },
                        {
                            etapa: 'Verificaci√≥n de Condiciones Sanitarias',
                            fecha: null,
                            descripcion: 'Verificaci√≥n de limpieza, ventilaci√≥n, iluminaci√≥n, agua potable, control de plagas y manejo de residuos',
                            inspector: null,
                            notas: '',
                            completado: false
                        },
                        {
                            etapa: 'Verificaci√≥n de Buenas Pr√°cticas de Manufactura (BPM)',
                            fecha: null,
                            descripcion: 'Verificaci√≥n de control de temperaturas, almacenamiento, manipulaci√≥n higi√©nica, equipos desinfectados y carn√© de salud de empleados',
                            inspector: null,
                            notas: '',
                            completado: false
                        },
                        {
                            etapa: 'Primera Visita de Inspecci√≥n Sanitaria',
                            fecha: null,
                            descripcion: 'Inspecci√≥n f√≠sica del establecimiento por inspector sanitario de la Secretar√≠a de Salud',
                            inspector: null,
                            notas: '',
                            completado: false
                        },
                        {
                            etapa: 'Revisi√≥n y Evaluaci√≥n',
                            fecha: null,
                            descripcion: 'Evaluaci√≥n del cumplimiento de normas sanitarias (Decreto 3075 de 1997 y Resoluci√≥n 2674 de 2013)',
                            inspector: null,
                            notas: '',
                            completado: false
                        },
                        {
                            etapa: 'Segunda Visita (Correcci√≥n de Requerimientos)',
                            fecha: null,
                            descripcion: 'Si hubo requerimientos, verificaci√≥n de correcciones realizadas por el establecimiento',
                            inspector: null,
                            notas: '',
                            completado: false
                        },
                        {
                            etapa: 'Emisi√≥n de Concepto Sanitario',
                            fecha: null,
                            descripcion: 'Emisi√≥n del resultado final: Favorable, Favorable con requerimientos, o Desfavorable',
                            inspector: null,
                            notas: '',
                            completado: false
                        }
                    ],
                    documentosRequeridos: this.getDocumentosRequeridos('panaderia'),
                    documentosSubidos: []
                }
            ];
            this.saveData();
        }
    },
    
    saveData() {
        localStorage.setItem('tramites', JSON.stringify(this.tramites));
    },
    
    // ========== MEJORAS: ATAJOS DE TECLADO ==========
    setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            // Ignorar si el usuario est√° escribiendo en un input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                return;
            }

            // Ctrl/Cmd + K: B√∫squeda global
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                this.showGlobalSearch();
            }

            // Ctrl/Cmd + N: Nuevo tr√°mite (solo comercio)
            if ((e.ctrlKey || e.metaKey) && e.key === 'n' && this.currentUser?.tipo === 'comercio') {
                e.preventDefault();
                const nuevoBtn = document.getElementById('nuevoTramiteBtn');
                if (nuevoBtn) nuevoBtn.click();
            }

            // Esc: Cerrar modales
            if (e.key === 'Escape') {
                const activeModal = document.querySelector('.modal.active');
                if (activeModal) {
                    activeModal.classList.remove('active');
                }
            }

            // Ctrl/Cmd + /: Mostrar ayuda de atajos
            if ((e.ctrlKey || e.metaKey) && e.key === '/') {
                e.preventDefault();
                this.showKeyboardShortcutsHelp();
            }

            // Teclas num√©ricas para navegaci√≥n r√°pida (si est√° en dashboard)
            if (e.key >= '1' && e.key <= '9' && !e.ctrlKey && !e.metaKey && !e.altKey) {
                const activeScreen = document.querySelector('.screen.active');
                if (activeScreen && (activeScreen.id === 'comercioDashboard' || activeScreen.id === 'inspectorDashboard')) {
                    const num = parseInt(e.key);
                    if (num === 2) {
                        const notifBtn = document.getElementById('notificationsBtn') || document.getElementById('notificationsBtnInspector');
                        if (notifBtn) notifBtn.click();
                    } else if (num === 3) {
                        const profileBtn = document.getElementById('profileBtnComercio') || document.getElementById('profileBtnInspector');
                        if (profileBtn) profileBtn.click();
                    }
                }
            }
        });
    },

    showKeyboardShortcutsHelp() {
        const shortcuts = [
            { key: 'Ctrl/Cmd + K', action: 'B√∫squeda r√°pida' },
            { key: 'Ctrl/Cmd + N', action: 'Nuevo tr√°mite (Comercio)' },
            { key: 'Esc', action: 'Cerrar modales' },
            { key: 'Ctrl/Cmd + /', action: 'Mostrar esta ayuda' },
            { key: '2', action: 'Ir a Notificaciones' },
            { key: '3', action: 'Ir a Perfil' }
        ];

        const helpHtml = `
            <div class="keyboard-shortcuts-modal">
                <h2>‚å®Ô∏è Atajos de Teclado</h2>
                <div class="shortcuts-list">
                    ${shortcuts.map(s => `
                        <div class="shortcut-item">
                            <kbd>${s.key}</kbd>
                            <span>${s.action}</span>
                        </div>
                    `).join('')}
                </div>
                <button class="btn btn-primary" onclick="this.closest('.modal').classList.remove('active')">Cerrar</button>
            </div>
        `;

        let modal = document.getElementById('keyboardShortcutsModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'keyboardShortcutsModal';
            modal.className = 'modal';
            document.body.appendChild(modal);
        }
        modal.innerHTML = `<div class="modal-content">${helpHtml}</div>`;
        modal.classList.add('active');
    },
    
    setupEventListeners() {
        // Welcome screen - Go to login
        document.getElementById('goToLoginBtn')?.addEventListener('click', () => {
            this.goToLogin();
        });
        
        // Auth Tabs
        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                this.switchAuthTab(tabName);
            });
        });
        
        // Login
        document.getElementById('loginForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleLogin();
        });
        
        // Signup
        document.getElementById('signupForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleSignup();
        });
        
        // Toggle password visibility
        document.querySelectorAll('.toggle-password').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const input = e.target.closest('.password-input-wrapper').querySelector('input');
                const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                input.setAttribute('type', type);
                btn.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
            });
        });
        
        // Password strength indicator
        const signupPassword = document.getElementById('signupPassword');
        if (signupPassword) {
            signupPassword.addEventListener('input', () => {
                this.checkPasswordStrength(signupPassword.value);
            });
        }
        
        // Signup user type change
        const signupUserType = document.getElementById('signupUserType');
        if (signupUserType) {
            signupUserType.addEventListener('change', () => {
                this.toggleSignupFields(signupUserType.value);
            });
        }
        
        // Copy credentials
        document.querySelectorAll('.btn-copy-cred').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const email = btn.dataset.email;
                const password = btn.dataset.password;
                this.copyCredentials(email, password);
            });
        });
        
        // Logout
        document.getElementById('logoutBtn')?.addEventListener('click', () => this.handleLogout());
        document.getElementById('logoutBtnInspector')?.addEventListener('click', () => this.handleLogout());
        
        // Navegaci√≥n Comercio
        // B√∫squeda global
        document.getElementById('globalSearchBtn')?.addEventListener('click', () => {
            this.showGlobalSearch();
        });
        document.getElementById('globalSearchBtnInspector')?.addEventListener('click', () => {
            this.showGlobalSearch();
        });
        
        document.getElementById('notificationsBtn')?.addEventListener('click', () => {
            this.navigateToSection('notificationsSectionComercio');
        });
        document.getElementById('profileBtnComercio')?.addEventListener('click', () => {
            this.navigateToSection('profileSectionComercio');
        });
        
        // Navegaci√≥n Inspector
        document.getElementById('statsBtn')?.addEventListener('click', () => {
            this.navigateToSection('statsSectionInspector');
        });
        document.getElementById('calendarBtn')?.addEventListener('click', () => {
            this.navigateToSection('calendarSectionInspector');
        });
        document.getElementById('notificationsBtnInspector')?.addEventListener('click', () => {
            this.navigateToSection('notificationsSectionInspector');
        });
        document.getElementById('profileBtnInspector')?.addEventListener('click', () => {
            this.navigateToSection('profileSectionInspector');
        });
        
        // Logout desde navegaci√≥n
        document.querySelectorAll('#logoutBtnNav, #logoutBtnNav2, #logoutBtnNavInspector, #logoutBtnNavInspector2, #logoutBtnNavInspector3, #logoutBtnNavInspector4').forEach(btn => {
            btn?.addEventListener('click', () => this.handleLogout());
        });
        
        // Toggle de tema oscuro
        document.querySelectorAll('.theme-toggle').forEach(btn => {
            btn.addEventListener('click', () => this.toggleTheme());
        });
        
        // Nuevo tr√°mite
        document.getElementById('nuevoTramiteBtn')?.addEventListener('click', () => {
            document.getElementById('nuevoTramiteModal').classList.add('active');
        });
        
        document.getElementById('nuevoTramiteForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            this.crearNuevoTramite();
        });
        
        // Cerrar modales
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', (e) => {
                e.target.closest('.modal').classList.remove('active');
            });
        });
        
        // Click fuera del modal para cerrar
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
        
        // Filtros inspector
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                this.renderInspectorTramites(tab.dataset.filter);
            });
        });
        
        // Verificar si hay sesi√≥n activa
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            this.currentUser = JSON.parse(savedUser);
            this.showDashboard(this.currentUser.tipo);
        }
        
        // Configurar nuevos event listeners
        this.setupNewEventListeners();
    },
    
    switchAuthTab(tabName) {
        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.tab === tabName);
        });
        document.querySelectorAll('.auth-form').forEach(form => {
            form.classList.toggle('active', form.id === `${tabName}Form`);
        });
    },
    
    toggleSignupFields(userType) {
        const telefonoGroup = document.getElementById('signupTelefonoGroup');
        const direccionGroup = document.getElementById('signupDireccionGroup');
        
        if (userType === 'comercio') {
            telefonoGroup.style.display = 'block';
            direccionGroup.style.display = 'block';
        } else {
            telefonoGroup.style.display = 'block';
            direccionGroup.style.display = 'none';
        }
    },
    
    checkPasswordStrength(password) {
        const strengthBar = document.getElementById('passwordStrength');
        if (!strengthBar) return;
        
        let strength = 0;
        if (password.length >= 6) strength++;
        if (password.length >= 8) strength++;
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
        if (/\d/.test(password)) strength++;
        if (/[^a-zA-Z\d]/.test(password)) strength++;
        
        strengthBar.className = 'password-strength';
        if (strength <= 2) {
            strengthBar.classList.add('weak');
        } else if (strength <= 3) {
            strengthBar.classList.add('medium');
        } else {
            strengthBar.classList.add('strong');
        }
    },
    
    copyCredentials(email, password) {
        const text = `Email: ${email}\nContrase√±a: ${password}`;
        navigator.clipboard.writeText(text).then(() => {
            this.showNotification('Credenciales copiadas al portapapeles', 'success');
        }).catch(() => {
            // Fallback para navegadores que no soportan clipboard API
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            this.showNotification('Credenciales copiadas al portapapeles', 'success');
        });
        
        // Auto-fill si estamos en login
        const loginEmail = document.getElementById('email');
        const loginPassword = document.getElementById('password');
        if (loginEmail && loginPassword) {
            loginEmail.value = email;
            loginPassword.value = password;
            this.showNotification('Credenciales cargadas autom√°ticamente', 'info');
        }
    },
    
    async handleLogin() {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const userType = document.getElementById('userType').value;
        const rememberMe = document.getElementById('rememberMe')?.checked;
        
        if (!userType) {
            this.showNotification('Por favor selecciona un tipo de usuario', 'error');
            return;
        }
        
        if (!email || !password) {
            this.showNotification('Por favor completa todos los campos', 'error');
            return;
        }

        // Intentar login con backend primero
        try {
            const response = await api.login(email, password, userType);
            
            if (response.success && response.data) {
                this.currentUser = response.data.user;
                
                if (rememberMe) {
                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                }
                
                this.showNotification('Inicio de sesi√≥n exitoso. Revisa tu email para ver los detalles de acceso.', 'success');
                
                setTimeout(() => {
                    this.showDashboard(userType);
                }, 500);
                return;
            }
        } catch (error) {
            // Si falla el backend, intentar con localStorage (modo demo)
            console.log('Backend no disponible, usando modo demo:', error.message);
            
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const validCredentials = {
                'comercio': { email: 'comercio@demo.com', password: 'demo123' },
                'inspector': { email: 'inspector@demo.com', password: 'demo123' }
            };
            
            const user = users.find(u => u.email === email && u.tipo === userType);
            const cred = validCredentials[userType];
            
            let isValid = false;
            let userData = null;
            
            if (user && user.password === password) {
                isValid = true;
                userData = user;
            } else if (cred && email === cred.email && password === cred.password) {
                isValid = true;
                userData = {
                    email,
                    tipo: userType,
                    nombre: userType === 'comercio' ? 'Restaurante El Buen Sabor' : 'Inspector Sanitario'
                };
            }
            
            if (isValid) {
                this.currentUser = userData;
                if (rememberMe) {
                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                }
                this.showNotification('Inicio de sesi√≥n exitoso (modo demo)', 'success');
                setTimeout(() => {
                    this.showDashboard(userType);
                }, 500);
            } else {
                this.showNotification('Credenciales incorrectas. Verifica tus datos o usa las credenciales de demostraci√≥n.', 'error');
            }
        }
    },
    
    async handleSignup() {
        const userType = document.getElementById('signupUserType').value;
        const nombre = document.getElementById('signupNombre').value.trim();
        const email = document.getElementById('signupEmail').value.trim();
        const password = document.getElementById('signupPassword').value;
        const confirmPassword = document.getElementById('signupConfirmPassword').value;
        const telefono = document.getElementById('signupTelefono')?.value.trim() || '';
        const direccion = document.getElementById('signupDireccion')?.value.trim() || '';
        const acceptTerms = document.getElementById('acceptTerms').checked;
        
        // Validaciones
        if (!userType) {
            this.showNotification('Por favor selecciona un tipo de usuario', 'error');
            return;
        }
        
        if (!nombre || nombre.length < 3) {
            this.showNotification('El nombre debe tener al menos 3 caracteres', 'error');
            return;
        }
        
        if (!this.isValidEmail(email)) {
            this.showNotification('Por favor ingresa un correo electr√≥nico v√°lido', 'error');
            return;
        }
        
        if (password.length < 6) {
            this.showNotification('La contrase√±a debe tener al menos 6 caracteres', 'error');
            return;
        }
        
        if (password !== confirmPassword) {
            this.showNotification('Las contrase√±as no coinciden', 'error');
            return;
        }
        
        if (!acceptTerms) {
            this.showNotification('Debes aceptar los t√©rminos y condiciones', 'error');
            return;
        }
        
        // Campos espec√≠ficos seg√∫n tipo
        let nombreComercio = '';
        let tipoComercio = '';
        let numeroIdentificacion = '';
        
        if (userType === 'comercio') {
            nombreComercio = document.getElementById('signupNombreComercio')?.value.trim() || '';
            tipoComercio = document.getElementById('signupTipoComercio')?.value || '';
        } else if (userType === 'inspector') {
            numeroIdentificacion = document.getElementById('signupNumeroIdentificacion')?.value.trim() || '';
        }
        
        // Intentar registro con backend primero
        try {
            const userData = {
                nombre,
                email,
                password,
                tipo: userType,
                telefono,
                direccion,
                ...(userType === 'comercio' && { nombreComercio, tipoComercio }),
                ...(userType === 'inspector' && { numeroIdentificacion })
            };
            
            const response = await api.register(userData);
            
            if (response.success) {
                this.showNotification('Cuenta creada exitosamente. Revisa tu email para confirmar tu registro. Ahora puedes iniciar sesi√≥n.', 'success');
                
                // Guardar tambi√©n en localStorage como backup
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                users.push({
                    ...userData,
                    fechaCreacion: new Date().toISOString()
                });
                localStorage.setItem('users', JSON.stringify(users));
                
                // Cambiar a tab de login y pre-llenar datos
                setTimeout(() => {
                    this.switchAuthTab('login');
                    document.getElementById('email').value = email;
                    document.getElementById('userType').value = userType;
                }, 1500);
                return;
            }
        } catch (error) {
            // Si falla el backend, usar localStorage (modo demo)
            console.log('Backend no disponible, guardando en localStorage:', error.message);
            
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            if (users.some(u => u.email === email)) {
                this.showNotification('Este correo electr√≥nico ya est√° registrado', 'error');
                return;
            }
            
            const newUser = {
                id: Date.now().toString(),
                nombre,
                email,
                password,
                tipo: userType,
                telefono,
                direccion: userType === 'comercio' ? direccion : '',
                fechaRegistro: new Date().toISOString()
            };
            
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            
            this.showNotification('Cuenta creada exitosamente (modo demo). Ahora puedes iniciar sesi√≥n.', 'success');
            
            setTimeout(() => {
                this.switchAuthTab('login');
                document.getElementById('email').value = email;
                document.getElementById('userType').value = userType;
            }, 1000);
        }
    },
    
    isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    },
    
    handleLogout() {
        this.currentUser = null;
        localStorage.removeItem('currentUser');
        this.showScreen('loginScreen');
        this.updateChatbotVisibility();
    },
    
    showDashboard(userType) {
        if (userType === 'comercio') {
            this.showScreen('comercioDashboard');
            this.renderComercioTramites();
            this.updateComercioWidgets();
        } else {
            this.showScreen('inspectorDashboard');
            this.renderInspectorTramites('all');
            this.updateInspectorWidgets();
        }
        this.updateNotificationBadges();
        this.updateChatbotVisibility();
    },
    
    showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });
        const screen = document.getElementById(screenId);
        if (screen) {
            screen.classList.add('active');
            // Actualizar breadcrumbs si estamos en un dashboard o secci√≥n
            if (this.currentUser) {
                setTimeout(() => this.updateBreadcrumbs(), 100);
            }
            // Actualizar visibilidad del chatbot y footer
            this.updateChatbotVisibility();
        }
    },
    
    goToLogin() {
        this.showScreen('loginScreen');
    },
    
    navigateToSection(sectionId) {
        this.showScreen(sectionId);
        
        // Cargar contenido seg√∫n la secci√≥n
        setTimeout(() => {
            if (sectionId === 'notificationsSectionComercio') {
                this.renderNotificationsSection('comercio');
            } else if (sectionId === 'profileSectionComercio') {
                this.renderProfileSection('comercio');
            } else if (sectionId === 'statsSectionInspector') {
                this.renderStatsSection();
            } else if (sectionId === 'calendarSectionInspector') {
                this.renderCalendarSection();
            } else if (sectionId === 'notificationsSectionInspector') {
                this.renderNotificationsSection('inspector');
            } else if (sectionId === 'profileSectionInspector') {
                this.renderProfileSection('inspector');
            }
        }, 100);
        
        // Actualizar breadcrumbs y nombres en navegaci√≥n
        this.updateBreadcrumbs();
        this.updateNavNames();
    },
    
    updateNavNames() {
        // Los nombres ya no se muestran en el header
    },
    
    renderNotificationsSection(userType) {
        const container = userType === 'comercio' 
            ? document.getElementById('notificationsContentComercio')
            : document.getElementById('notificationsContentInspector');
        
        if (!container) return;
        
        // Filtrar notificaciones seg√∫n el tipo de usuario
        let allNotifications = [];
        if (userType === 'comercio') {
            allNotifications = this.notifications.filter(n => 
                n.tramiteId && this.tramites.some(t => t.id === n.tramiteId && t.comercioId === this.currentUser.email)
            );
        } else {
            allNotifications = this.notifications;
        }
        
        // Ordenar por fecha (m√°s recientes primero)
        allNotifications.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        
        const unreadCount = allNotifications.filter(n => !n.read).length;
        const readCount = allNotifications.filter(n => n.read).length;
        
        // Obtener filtro actual o usar 'all'
        const currentFilter = this.notificationFilter || 'all';
        let filteredNotifications = allNotifications;
        
        if (currentFilter === 'unread') {
            filteredNotifications = allNotifications.filter(n => !n.read);
        } else if (currentFilter === 'read') {
            filteredNotifications = allNotifications.filter(n => n.read);
        }
        
        container.innerHTML = `
            <div class="notifications-container">
                <div class="notifications-header">
                    <div class="notifications-stats">
                        <div class="stat-badge">
                            <span class="stat-label">Total</span>
                            <span class="stat-number">${allNotifications.length}</span>
                        </div>
                        <div class="stat-badge unread-badge">
                            <span class="stat-label">No le√≠das</span>
                            <span class="stat-number">${unreadCount}</span>
                        </div>
                        <div class="stat-badge read-badge">
                            <span class="stat-label">Le√≠das</span>
                            <span class="stat-number">${readCount}</span>
                        </div>
                    </div>
                    <div class="notifications-actions">
                        <div class="filter-buttons">
                            <button class="filter-btn ${currentFilter === 'all' ? 'active' : ''}" onclick="AppState.setNotificationFilter('all')">
                                Todas
                            </button>
                            <button class="filter-btn ${currentFilter === 'unread' ? 'active' : ''}" onclick="AppState.setNotificationFilter('unread')">
                                No le√≠das
                            </button>
                            <button class="filter-btn ${currentFilter === 'read' ? 'active' : ''}" onclick="AppState.setNotificationFilter('read')">
                                Le√≠das
                            </button>
                        </div>
                        ${unreadCount > 0 ? `
                            <button class="btn btn-secondary" onclick="AppState.markAllNotificationsAsRead('${userType}')">
                                Marcar todas como le√≠das
                            </button>
                        ` : ''}
                    </div>
                </div>
                
                ${filteredNotifications.length === 0 ? `
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <h3>No hay notificaciones</h3>
                        <p>${currentFilter === 'unread' ? 'No tienes notificaciones sin leer' : currentFilter === 'read' ? 'No tienes notificaciones le√≠das' : 'A√∫n no has recibido notificaciones'}</p>
                    </div>
                ` : `
                    <div class="notifications-list">
                        ${filteredNotifications.map((notif) => {
                            const tramite = this.tramites.find(t => t.id === notif.tramiteId);
                            const icon = this.getNotificationIcon(notif.type);
                            const timeAgo = this.getTimeAgo(new Date(notif.fecha));
                            
                            return `
                                <div class="notification-item ${notif.read ? 'read' : 'unread'}" data-id="${notif.id}">
                                    <div class="notification-icon ${notif.type}">
                                        ${icon}
                                    </div>
                                    <div class="notification-content">
                                        <div class="notification-header">
                                            <h4>${this.getNotificationTitle(notif.type)}</h4>
                                            ${!notif.read ? '<span class="unread-indicator"></span>' : ''}
                                        </div>
                                        <p class="notification-message">${notif.message}</p>
                                        ${tramite ? `
                                            <div class="notification-tramite">
                                                <span class="tramite-link" onclick="AppState.viewTramiteFromNotification('${notif.tramiteId}')">
                                                    Ver tr√°mite ${tramite.id}
                                                </span>
                                            </div>
                                        ` : ''}
                                        <div class="notification-footer">
                                            <span class="notification-date">${timeAgo}</span>
                                            <div class="notification-actions">
                                                ${!notif.read ? `
                                                    <button class="btn-icon-small" onclick="AppState.markNotificationReadById('${notif.id}')" title="Marcar como le√≠da">
                                                        ‚úì
                                                    </button>
                                                ` : ''}
                                                <button class="btn-icon-small delete-btn" onclick="AppState.deleteNotification('${notif.id}', '${userType}')" title="Eliminar">
                                                    √ó
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `}
            </div>
        `;
    },
    
    setNotificationFilter(filter) {
        this.notificationFilter = filter;
        const userType = this.currentUser.tipo;
        this.renderNotificationsSection(userType);
    },
    
    getNotificationIcon(type) {
        const icons = {
            'success': '‚úì',
            'error': '‚úï',
            'info': '‚Ñπ',
            'warning': '‚ö†'
        };
        return icons[type] || '‚Ä¢';
    },
    
    getTimeAgo(date) {
        const now = new Date();
        const diff = now - date;
        const seconds = Math.floor(diff / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        
        if (days > 7) {
            return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
        } else if (days > 0) {
            return `Hace ${days} ${days === 1 ? 'd√≠a' : 'd√≠as'}`;
        } else if (hours > 0) {
            return `Hace ${hours} ${hours === 1 ? 'hora' : 'horas'}`;
        } else if (minutes > 0) {
            return `Hace ${minutes} ${minutes === 1 ? 'minuto' : 'minutos'}`;
        } else {
            return 'Hace unos momentos';
        }
    },
    
    markAllNotificationsAsRead(userType) {
        const notificationsToUpdate = this.notifications.filter(n => !n.read);
        notificationsToUpdate.forEach(n => {
            n.read = true;
        });
        this.saveNotifications();
        this.renderNotificationsSection(userType);
        this.updateNotificationBadges();
    },
    
    deleteNotification(notificationId, userType) {
        if (confirm('¬øEst√°s seguro de que deseas eliminar esta notificaci√≥n?')) {
            this.notifications = this.notifications.filter(n => n.id !== notificationId);
            this.saveNotifications();
            this.renderNotificationsSection(userType);
            this.updateNotificationBadges();
        }
    },
    
    viewTramiteFromNotification(tramiteId) {
        const tramite = this.tramites.find(t => t.id === tramiteId);
        if (tramite) {
            // Volver al dashboard
            const userType = this.currentUser.tipo;
            if (userType === 'comercio') {
                this.navigateToSection('comercioDashboard');
            } else {
                this.navigateToSection('inspectorDashboard');
            }
            // Abrir el modal del tr√°mite
            setTimeout(() => {
                this.showTramiteDetail(tramiteId);
            }, 300);
        }
    },
    
    getNotificationTitle(type) {
        const titles = {
            'success': '√âxito',
            'error': 'Error',
            'info': 'Informaci√≥n',
            'warning': 'Advertencia'
        };
        return titles[type] || 'Notificaci√≥n';
    },
    
    renderProfileSection(userType) {
        const container = userType === 'comercio'
            ? document.getElementById('profileContentComercio')
            : document.getElementById('profileContentInspector');
        
        if (!container) return;
        
        const user = this.currentUser || {};
        const tipoUsuario = user.tipo === 'comercio' ? 'Comercio' : 'Inspector Sanitario';
        
        container.innerHTML = `
            <div class="profile-container">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <div class="avatar-circle">
                            <span>${(user.nombre || 'U').charAt(0).toUpperCase()}</span>
                        </div>
                    </div>
                    <div class="profile-info-header">
                        <h2>${user.nombre || 'Usuario'}</h2>
                        <p class="profile-role">${tipoUsuario}</p>
                        <p class="profile-email">${user.email || ''}</p>
                    </div>
                </div>
                
                <div class="profile-sections">
                    <div class="profile-card">
                        <h3>Informaci√≥n Personal</h3>
                        <form id="profileFormSection">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nombre Completo</label>
                                    <input type="text" id="profileNombreSection" value="${user.nombre || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label>Correo Electr√≥nico</label>
                                    <input type="email" id="profileEmailSection" value="${user.email || ''}" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Tel√©fono</label>
                                    <input type="tel" id="profileTelefonoSection" value="${user.telefono || ''}" placeholder="Ej: +57 300 123 4567">
                                </div>
                                ${user.tipo === 'comercio' ? `
                                <div class="form-group">
                                    <label>Direcci√≥n</label>
                                    <input type="text" id="profileDireccionSection" value="${user.direccion || ''}" placeholder="Direcci√≥n del comercio">
                                </div>
                                ` : `
                                <div class="form-group">
                                    <label>N√∫mero de Identificaci√≥n</label>
                                    <input type="text" id="profileIdentificacionSection" value="${user.identificacion || ''}" placeholder="C√©dula o documento">
                                </div>
                                `}
                            </div>
                            ${user.tipo === 'comercio' ? `
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Tipo de Comercio</label>
                                    <input type="text" id="profileTipoComercioSection" value="${user.tipoComercio || ''}" placeholder="Restaurante, Tienda, etc." readonly style="background: var(--gray-100);">
                                </div>
                            </div>
                            ` : ''}
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="profile-card">
                        <h3>Seguridad</h3>
                        <form id="passwordFormSection">
                            <div class="form-group">
                                <label>Contrase√±a Actual</label>
                                <input type="password" id="oldPasswordSection" placeholder="Ingresa tu contrase√±a actual">
                                <small class="form-help">Dejar vac√≠o si no deseas cambiar la contrase√±a</small>
                            </div>
                            <div class="form-group">
                                <label>Nueva Contrase√±a</label>
                                <input type="password" id="newPasswordSection" placeholder="M√≠nimo 6 caracteres">
                            </div>
                            <div class="form-group">
                                <label>Confirmar Nueva Contrase√±a</label>
                                <input type="password" id="confirmPasswordSection" placeholder="Repite la nueva contrase√±a">
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-success">Cambiar Contrase√±a</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="profile-card">
                        <h3>Estad√≠sticas de Cuenta</h3>
                        <div class="profile-stats">
                            ${user.tipo === 'comercio' ? `
                            <div class="stat-item">
                                <span class="stat-label">Tr√°mites Totales</span>
                                <span class="stat-value">${this.tramites.filter(t => t.comercioId === user.id).length}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Tr√°mites Activos</span>
                                <span class="stat-value">${this.tramites.filter(t => t.comercioId === user.id && t.estado !== 'completado' && t.estado !== 'rechazado').length}</span>
                            </div>
                            ` : `
                            <div class="stat-item">
                                <span class="stat-label">Tr√°mites Asignados</span>
                                <span class="stat-value">${this.tramites.filter(t => t.inspectorId === user.id).length}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Tr√°mites Completados</span>
                                <span class="stat-value">${this.tramites.filter(t => t.inspectorId === user.id && t.estado === 'completado').length}</span>
                            </div>
                            `}
                            <div class="stat-item">
                                <span class="stat-label">Miembro desde</span>
                                <span class="stat-value">${user.fechaRegistro ? new Date(user.fechaRegistro).toLocaleDateString('es-ES', { year: 'numeric', month: 'long' }) : 'Reciente'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Event listeners
        const profileForm = document.getElementById('profileFormSection');
        if (profileForm) {
            profileForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.updateProfileFromSection();
            });
        }
        
        const passwordForm = document.getElementById('passwordFormSection');
        if (passwordForm) {
            passwordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.updatePasswordFromSection();
            });
        }
    },
    
    updateProfileFromSection() {
        this.currentUser.nombre = document.getElementById('profileNombreSection').value;
        this.currentUser.email = document.getElementById('profileEmailSection').value;
        this.currentUser.telefono = document.getElementById('profileTelefonoSection').value;
        
        if (this.currentUser.tipo === 'comercio') {
            this.currentUser.direccion = document.getElementById('profileDireccionSection').value;
        } else {
            this.currentUser.identificacion = document.getElementById('profileIdentificacionSection').value;
        }
        
        localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
        this.showNotification('Perfil actualizado exitosamente', 'success');
        
        // Re-renderizar para actualizar el avatar
        setTimeout(() => {
            this.renderProfileSection(this.currentUser.tipo);
        }, 500);
    },
    
    updatePasswordFromSection() {
        const oldPassword = document.getElementById('oldPasswordSection').value;
        const newPassword = document.getElementById('newPasswordSection').value;
        const confirmPassword = document.getElementById('confirmPasswordSection').value;
        
        if (!oldPassword && !newPassword && !confirmPassword) {
            this.showNotification('No se realizaron cambios en la contrase√±a', 'info');
            return;
        }
        
        if (!oldPassword || !newPassword || !confirmPassword) {
            this.showNotification('Por favor completa todos los campos para cambiar la contrase√±a', 'error');
            return;
        }
        
        if (oldPassword !== this.currentUser.password && oldPassword !== 'demo123') {
            this.showNotification('La contrase√±a actual no es correcta', 'error');
            return;
        }
        
        if (newPassword.length < 6) {
            this.showNotification('La nueva contrase√±a debe tener al menos 6 caracteres', 'error');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            this.showNotification('Las contrase√±as no coinciden', 'error');
            return;
        }
        
        this.currentUser.password = newPassword;
        localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
        this.showNotification('Contrase√±a actualizada exitosamente', 'success');
        
        // Limpiar campos
        document.getElementById('oldPasswordSection').value = '';
        document.getElementById('newPasswordSection').value = '';
        document.getElementById('confirmPasswordSection').value = '';
    },
    
    
    renderStatsSection() {
        const container = document.getElementById('statsContentInspector');
        if (!container) return;
        
        // Calcular estad√≠sticas
        const allTramites = this.tramites;
        const total = allTramites.length;
        const pendientes = allTramites.filter(t => t.estado === 'pendiente').length;
        const enProceso = allTramites.filter(t => t.estado === 'en-proceso').length;
        const completados = allTramites.filter(t => t.estado === 'completado').length;
        const rechazados = allTramites.filter(t => t.estado === 'rechazado').length;
        
        // Calcular porcentajes
        const porcentajeCompletados = total > 0 ? ((completados / total) * 100).toFixed(1) : 0;
        const porcentajeEnProceso = total > 0 ? ((enProceso / total) * 100).toFixed(1) : 0;
        const porcentajePendientes = total > 0 ? ((pendientes / total) * 100).toFixed(1) : 0;
        
        // Estad√≠sticas por tipo de comercio
        const tiposComercio = {};
        allTramites.forEach(t => {
            tiposComercio[t.tipoComercio] = (tiposComercio[t.tipoComercio] || 0) + 1;
        });
        
        // Estad√≠sticas por mes (√∫ltimos 6 meses)
        const meses = [];
        const datosPorMes = {};
        const now = new Date();
        for (let i = 5; i >= 0; i--) {
            const fecha = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const mesKey = fecha.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' });
            meses.push(mesKey);
            datosPorMes[mesKey] = { completados: 0, total: 0 };
        }
        
        allTramites.forEach(t => {
            const fecha = new Date(t.fechaCreacion);
            const mesKey = fecha.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' });
            if (datosPorMes[mesKey]) {
                datosPorMes[mesKey].total++;
                if (t.estado === 'completado') {
                    datosPorMes[mesKey].completados++;
                }
            }
        });
        
        // Tiempo promedio de procesamiento
        const tramitesCompletados = allTramites.filter(t => t.estado === 'completado' && t.historial && t.historial.length > 0);
        let tiempoPromedio = 0;
        if (tramitesCompletados.length > 0) {
            const tiempos = tramitesCompletados.map(t => {
                const inicio = new Date(t.fechaCreacion);
                const fin = new Date(t.historial[t.historial.length - 1].fecha);
                return (fin - inicio) / (1000 * 60 * 60 * 24); // d√≠as
            });
            tiempoPromedio = (tiempos.reduce((a, b) => a + b, 0) / tiempos.length).toFixed(1);
        }
        
        container.innerHTML = `
            <div class="stats-container">
                <div class="stats-header-section">
                    <div class="stats-period-selector">
                        <label>Per√≠odo:</label>
                        <select id="statsPeriod" onchange="AppState.updateStatsPeriod()">
                            <option value="all">Todos los tiempos</option>
                            <option value="month">Este mes</option>
                            <option value="quarter">Este trimestre</option>
                            <option value="year">Este a√±o</option>
                        </select>
                    </div>
                    <div class="stats-actions-header">
                        <button class="btn btn-success" onclick="AppState.exportarReporte()">
                            üìä Exportar Reporte
                        </button>
                        <button class="btn btn-secondary" onclick="AppState.imprimirReporte()">
                            üñ®Ô∏è Imprimir
                        </button>
                    </div>
                </div>
                
                <div class="stats-grid-enhanced">
                    <div class="stat-card-enhanced total">
                        <div class="stat-icon">üìã</div>
                        <div class="stat-info">
                            <h3>Total Tr√°mites</h3>
                            <p class="stat-number">${total}</p>
                            <span class="stat-subtitle">Registrados en el sistema</span>
                        </div>
                    </div>
                    
                    <div class="stat-card-enhanced pendiente">
                        <div class="stat-icon">‚è≥</div>
                        <div class="stat-info">
                            <h3>Pendientes</h3>
                            <p class="stat-number">${pendientes}</p>
                            <span class="stat-subtitle">${porcentajePendientes}% del total</span>
                        </div>
                    </div>
                    
                    <div class="stat-card-enhanced proceso">
                        <div class="stat-icon">üîÑ</div>
                        <div class="stat-info">
                            <h3>En Proceso</h3>
                            <p class="stat-number">${enProceso}</p>
                            <span class="stat-subtitle">${porcentajeEnProceso}% del total</span>
                        </div>
                    </div>
                    
                    <div class="stat-card-enhanced completado">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-info">
                            <h3>Completados</h3>
                            <p class="stat-number">${completados}</p>
                            <span class="stat-subtitle">${porcentajeCompletados}% del total</span>
                        </div>
                    </div>
                    
                    <div class="stat-card-enhanced rechazado">
                        <div class="stat-icon">‚ùå</div>
                        <div class="stat-info">
                            <h3>Rechazados</h3>
                            <p class="stat-number">${rechazados}</p>
                            <span class="stat-subtitle">${total > 0 ? ((rechazados / total) * 100).toFixed(1) : 0}% del total</span>
                        </div>
                    </div>
                    
                    <div class="stat-card-enhanced tiempo">
                        <div class="stat-icon">‚è±Ô∏è</div>
                        <div class="stat-info">
                            <h3>Tiempo Promedio</h3>
                            <p class="stat-number">${tiempoPromedio}</p>
                            <span class="stat-subtitle">D√≠as para completar</span>
                        </div>
                    </div>
                </div>
                
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>Distribuci√≥n por Estado</h3>
                        <div class="chart-container-enhanced">
                            <canvas id="estadosChartSection"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h3>Tendencia Mensual</h3>
                        <div class="chart-container-enhanced">
                            <canvas id="tendenciaChartSection"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>Tr√°mites por Tipo de Comercio</h3>
                        <div class="chart-container-enhanced">
                            <canvas id="tiposChartSection"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h3>Resumen de Actividad</h3>
                        <div class="activity-summary">
                            <div class="activity-item">
                                <span class="activity-label">Tasa de √âxito</span>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${porcentajeCompletados}%"></div>
                                </div>
                                <span class="activity-value">${porcentajeCompletados}%</span>
                            </div>
                            <div class="activity-item">
                                <span class="activity-label">En Proceso</span>
                                <div class="progress-bar">
                                    <div class="progress-fill proceso" style="width: ${porcentajeEnProceso}%"></div>
                                </div>
                                <span class="activity-value">${porcentajeEnProceso}%</span>
                            </div>
                            <div class="activity-item">
                                <span class="activity-label">Pendientes</span>
                                <div class="progress-bar">
                                    <div class="progress-fill pendiente" style="width: ${porcentajePendientes}%"></div>
                                </div>
                                <span class="activity-value">${porcentajePendientes}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Renderizar gr√°ficos
        setTimeout(() => {
            // Gr√°fico de estados (doughnut)
            const ctxEstados = document.getElementById('estadosChartSection');
            if (ctxEstados) {
                new Chart(ctxEstados, {
                    type: 'doughnut',
                    data: {
                        labels: ['Pendientes', 'En Proceso', 'Completados', 'Rechazados'],
                        datasets: [{
                            data: [pendientes, enProceso, completados, rechazados],
                            backgroundColor: ['#d4a574', '#3f4d39', '#6b8e5a', '#c85a4a'],
                            borderWidth: 3,
                            borderColor: '#fffefa'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12,
                                        weight: '600'
                                    },
                                    color: '#2d3529'
                                }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico de tendencia (l√≠nea)
            const ctxTendencia = document.getElementById('tendenciaChartSection');
            if (ctxTendencia) {
                new Chart(ctxTendencia, {
                    type: 'line',
                    data: {
                        labels: meses,
                        datasets: [{
                            label: 'Completados',
                            data: meses.map(m => datosPorMes[m].completados),
                            borderColor: '#6b8e5a',
                            backgroundColor: 'rgba(107, 142, 90, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Total',
                            data: meses.map(m => datosPorMes[m].total),
                            borderColor: '#3f4d39',
                            backgroundColor: 'rgba(63, 77, 57, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 12,
                                        weight: '600'
                                    },
                                    color: '#2d3529'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#2d3529',
                                    font: {
                                        weight: '600'
                                    }
                                },
                                grid: {
                                    color: 'rgba(63, 77, 57, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#2d3529',
                                    font: {
                                        weight: '600'
                                    }
                                },
                                grid: {
                                    color: 'rgba(63, 77, 57, 0.1)'
                                }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico de tipos (barras horizontales)
            const tiposLabels = Object.keys(tiposComercio);
            const tiposData = Object.values(tiposComercio);
            const ctxTipos = document.getElementById('tiposChartSection');
            if (ctxTipos && tiposLabels.length > 0) {
                new Chart(ctxTipos, {
                    type: 'bar',
                    data: {
                        labels: tiposLabels.map(t => t.charAt(0).toUpperCase() + t.slice(1)),
                        datasets: [{
                            label: 'Cantidad',
                            data: tiposData,
                            backgroundColor: '#8fa382',
                            borderColor: '#3f4d39',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#2d3529',
                                    font: {
                                        weight: '600'
                                    }
                                },
                                grid: {
                                    color: 'rgba(63, 77, 57, 0.1)'
                                }
                            },
                            y: {
                                ticks: {
                                    color: '#2d3529',
                                    font: {
                                        weight: '600'
                                    }
                                },
                                grid: {
                                    color: 'rgba(63, 77, 57, 0.1)'
                                }
                            }
                        }
                    }
                });
            }
        }, 100);
    },
    
    updateStatsPeriod() {
        // Esta funci√≥n se puede expandir para filtrar por per√≠odo
        this.renderStatsSection();
    },
    
    renderCalendarSection() {
        const container = document.getElementById('calendarContentInspector');
        if (!container) return;
        
        const now = new Date();
        this.currentCalendarMonth = now.getMonth();
        this.currentCalendarYear = now.getFullYear();
        
        container.innerHTML = `
            <div class="calendar-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <button id="prevMonthSection" class="btn btn-secondary">‚Üê</button>
                <h3 id="currentMonthSection"></h3>
                <button id="nextMonthSection" class="btn btn-secondary">‚Üí</button>
            </div>
            <div id="calendarGridSection" class="calendar-grid"></div>
        `;
        
        this.renderCalendarSectionContent();
        
        // Event listeners
        document.getElementById('prevMonthSection')?.addEventListener('click', () => {
            this.currentCalendarMonth--;
            if (this.currentCalendarMonth < 0) {
                this.currentCalendarMonth = 11;
                this.currentCalendarYear--;
            }
            this.renderCalendarSectionContent();
        });
        
        document.getElementById('nextMonthSection')?.addEventListener('click', () => {
            this.currentCalendarMonth++;
            if (this.currentCalendarMonth > 11) {
                this.currentCalendarMonth = 0;
                this.currentCalendarYear++;
            }
            this.renderCalendarSectionContent();
        });
    },
    
    renderCalendarSectionContent() {
        const grid = document.getElementById('calendarGridSection');
        const monthHeader = document.getElementById('currentMonthSection');
        
        if (!grid || !monthHeader) return;
        
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        monthHeader.textContent = `${monthNames[this.currentCalendarMonth]} ${this.currentCalendarYear}`;
        
        const firstDay = new Date(this.currentCalendarYear, this.currentCalendarMonth, 1);
        const lastDay = new Date(this.currentCalendarYear, this.currentCalendarMonth + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        
        const days = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
        let html = days.map(d => `<div class="calendar-day-header">${d}</div>`).join('');
        
        for (let i = 0; i < startingDayOfWeek; i++) {
            html += '<div class="calendar-day"></div>';
        }
        
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(this.currentCalendarYear, this.currentCalendarMonth, day);
            const dateStr = date.toISOString().split('T')[0];
            const hasVisit = this.tramites.some(t => {
                return t.historial.some(h => h.fecha && h.fecha.split('T')[0] === dateStr);
            });
            const isToday = date.toDateString() === today.toDateString();
            
            html += `<div class="calendar-day ${hasVisit ? 'has-visit' : ''} ${isToday ? 'today' : ''}" onclick="AppState.showDayVisits('${dateStr}')">${day}</div>`;
        }
        
        grid.innerHTML = html;
    },
    
    crearNuevoTramite() {
        const tipoComercio = document.getElementById('tipoComercio').value;
        const nuevoTramite = {
            id: `TRM-${String(this.tramites.length + 1).padStart(3, '0')}`,
            comercioId: this.currentUser.email,
            nombreComercio: document.getElementById('nombreComercio').value,
            direccion: document.getElementById('direccion').value,
            tipoComercio: tipoComercio,
            telefono: document.getElementById('telefono').value,
            estado: 'pendiente',
            fechaCreacion: new Date().toISOString(),
            historial: [
                {
                    etapa: 'Notificaci√≥n del Establecimiento',
                    fecha: new Date().toISOString(),
                    descripcion: 'El comercio ha notificado su apertura o funcionamiento ante la Secretar√≠a de Salud',
                    inspector: null,
                    notas: 'Tr√°mite registrado en el sistema',
                    completado: true
                },
                {
                    etapa: 'Verificaci√≥n de Documentaci√≥n B√°sica',
                    fecha: null,
                    descripcion: 'Revisi√≥n de documentos legales: Certificado de C√°mara de Comercio, RUT, Concepto de Uso de Suelo',
                    inspector: null,
                    notas: '',
                    completado: false
                },
                {
                    etapa: 'Verificaci√≥n de Condiciones Sanitarias',
                    fecha: null,
                    descripcion: 'Verificaci√≥n de limpieza, ventilaci√≥n, iluminaci√≥n, agua potable, control de plagas y manejo de residuos',
                    inspector: null,
                    notas: '',
                    completado: false
                },
                {
                    etapa: 'Verificaci√≥n de Buenas Pr√°cticas de Manufactura (BPM)',
                    fecha: null,
                    descripcion: 'Verificaci√≥n de control de temperaturas, almacenamiento, manipulaci√≥n higi√©nica, equipos desinfectados y carn√© de salud de empleados',
                    inspector: null,
                    notas: '',
                    completado: false
                },
                {
                    etapa: 'Primera Visita de Inspecci√≥n Sanitaria',
                    fecha: null,
                    descripcion: 'Inspecci√≥n f√≠sica del establecimiento por inspector sanitario de la Secretar√≠a de Salud',
                    inspector: null,
                    notas: '',
                    completado: false
                },
                {
                    etapa: 'Revisi√≥n y Evaluaci√≥n',
                    fecha: null,
                    descripcion: 'Evaluaci√≥n del cumplimiento de normas sanitarias (Decreto 3075 de 1997 y Resoluci√≥n 2674 de 2013)',
                    inspector: null,
                    notas: '',
                    completado: false
                },
                {
                    etapa: 'Segunda Visita (Correcci√≥n de Requerimientos)',
                    fecha: null,
                    descripcion: 'Si hubo requerimientos, verificaci√≥n de correcciones realizadas por el establecimiento',
                    inspector: null,
                    notas: '',
                    completado: false
                },
                {
                    etapa: 'Emisi√≥n de Concepto Sanitario',
                    fecha: null,
                    descripcion: 'Emisi√≥n del resultado final: Favorable, Favorable con requerimientos, o Desfavorable',
                    inspector: null,
                    notas: '',
                    completado: false
                }
            ],
            documentosRequeridos: this.getDocumentosRequeridos(tipoComercio),
            documentosSubidos: []
        };
        
        this.tramites.push(nuevoTramite);
        this.saveData();
        document.getElementById('nuevoTramiteForm').reset();
        document.getElementById('nuevoTramiteModal').classList.remove('active');
        this.renderComercioTramites();
        this.updateComercioWidgets();
        this.showNotification('Tr√°mite creado exitosamente', 'success');
    },
    
    renderComercioTramites() {
        this.filterAndRenderComercio();
    },
    
    renderInspectorTramites(filter = 'all') {
        // Actualizar filtro activo
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`.filter-tab[data-filter="${filter}"]`)?.classList.add('active');
        document.getElementById('filterEstadoInspector').value = filter === 'all' ? 'all' : filter;
        this.filterAndRenderInspector();
    },
    
    createTramiteCard(tramite) {
        const estadoLabels = {
            'pendiente': 'Pendiente',
            'en-proceso': 'En Proceso',
            'completado': 'Completado',
            'rechazado': 'Rechazado'
        };
        
        const fecha = new Date(tramite.fechaCreacion).toLocaleDateString('es-CO', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
        
        return `
            <div class="tramite-card ${tramite.estado}" data-id="${tramite.id}">
                <div class="tramite-header">
                    <span class="tramite-id">${tramite.id}</span>
                    <span class="status-badge ${tramite.estado}">${estadoLabels[tramite.estado]}</span>
                </div>
                <div class="tramite-info">
                    <h3>${tramite.nombreComercio}</h3>
                    <p>Direcci√≥n: ${tramite.direccion}</p>
                    <p>Tipo: ${this.getTipoComercioLabel(tramite.tipoComercio)}</p>
                    <p>Tel√©fono: ${tramite.telefono}</p>
                </div>
                <div class="tramite-footer">
                    <span class="tramite-date">Creado: ${fecha}</span>
                </div>
            </div>
        `;
    },
    
    getTipoComercioLabel(tipo) {
        const tipos = {
            'restaurante': 'Restaurante',
            'panaderia': 'Panader√≠a',
            'carniceria': 'Carnicer√≠a',
            'supermercado': 'Supermercado',
            'cafeteria': 'Cafeter√≠a',
            'tienda': 'Tienda de Alimentos',
            'peluqueria': 'Peluquer√≠a/Barber√≠a',
            'gimnasio': 'Gimnasio',
            'spa': 'Spa',
            'otro': 'Otro'
        };
        return tipos[tipo] || tipo;
    },
    
    getCategoriaLabel(categoria) {
        const categorias = {
            'legal': 'Legal',
            'sanitario': 'Sanitario',
            'personal': 'Personal',
            'capacitacion': 'Capacitaci√≥n',
            'invima': 'INVIMA',
            'trazabilidad': 'Trazabilidad',
            'operativo': 'Operativo',
            'equipos': 'Equipos',
            'bioseguridad': 'Bioseguridad'
        };
        return categorias[categoria] || categoria;
    },
    
    showTramiteDetail(tramiteId, userType) {
        const tramite = this.tramites.find(t => t.id === tramiteId);
        if (!tramite) return;
        
        const modal = document.getElementById('tramiteDetailModal');
        const content = document.getElementById('tramiteDetailContent');
        
        const etapaActual = tramite.historial.find(h => !h.completado);
        const etapasCompletadas = tramite.historial.filter(h => h.completado).length;
        const totalEtapas = tramite.historial.length;
        
        let actionsHTML = '';
        if (userType === 'inspector') {
            const siguienteEtapa = tramite.historial.find(h => !h.completado);
            if (siguienteEtapa) {
                actionsHTML = `
                    <div class="inspector-actions">
                        <h3>Actualizar Etapa: ${siguienteEtapa.etapa}</h3>
                        <div class="form-group">
                            <label for="inspectorNotas">Notas y Observaciones</label>
                            <textarea id="inspectorNotas" placeholder="Ingrese notas sobre la visita o revisi√≥n..." rows="4"></textarea>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-success btn-sm" onclick="AppState.completarEtapa('${tramiteId}')">
                                Completar Etapa
                            </button>
                            ${tramite.estado === 'pendiente' ? `
                                <button class="btn btn-primary btn-sm" onclick="AppState.programarVisita('${tramiteId}')">
                                    Programar Visita
                                </button>
                            ` : ''}
                            ${tramite.estado === 'en-proceso' ? `
                                <button class="btn btn-success btn-sm" onclick="AppState.finalizarTramite('${tramiteId}', 'aprobado')">
                                    Concepto Favorable
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="AppState.finalizarTramite('${tramiteId}', 'requerimientos')">
                                    Concepto con Requerimientos
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="AppState.finalizarTramite('${tramiteId}', 'rechazado')">
                                    Concepto Desfavorable
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
        }
        
        // Botones adicionales para ambos usuarios
        const detailActions = `
            <div class="detail-actions">
                <button class="btn btn-primary btn-sm" onclick="AppState.showChatModal('${tramiteId}')">Mensajes</button>
                <button class="btn btn-primary btn-sm" onclick="AppState.showDocumentsModal('${tramiteId}')">Documentos</button>
                <button class="btn btn-primary btn-sm" onclick="AppState.showMapModal('${tramiteId}')">Ver Ubicaci√≥n</button>
                <button class="btn btn-secondary btn-sm" onclick="AppState.exportarTramitePDF('${tramiteId}')">Exportar PDF</button>
            </div>
        `;
        
        const documentosHTML = tramite.documentosRequeridos ? `
            <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Documentos Requeridos</h3>
            <div class="checklist">
                ${tramite.documentosRequeridos.map(doc => `
                    <div class="checklist-item ${doc.subido ? 'completed' : ''}">
                        <div class="checklist-content">
                            <span class="checklist-icon">${doc.subido ? '‚úì' : '‚óã'}</span>
                            <div>
                                <strong>${doc.nombre}</strong>
                                <span class="checklist-categoria">${this.getCategoriaLabel(doc.categoria)}</span>
                                ${doc.requerido ? '<span class="checklist-requerido">Requerido</span>' : '<span class="checklist-opcional">Opcional</span>'}
                            </div>
                        </div>
                        ${doc.subido && doc.fechaSubida ? `
                            <span class="checklist-fecha">Subido: ${new Date(doc.fechaSubida).toLocaleDateString('es-CO')}</span>
                        ` : ''}
                    </div>
                `).join('')}
            </div>
        ` : '';
        
        const conceptoResultadoHTML = tramite.conceptoResultado ? `
            <div class="concepto-resultado">
                <h3>Resultado del Concepto Sanitario</h3>
                <p class="concepto-texto ${tramite.conceptoResultado.includes('FAVORABLE') && !tramite.conceptoResultado.includes('REQUERIMIENTOS') ? 'favorable' : 
                    tramite.conceptoResultado.includes('REQUERIMIENTOS') ? 'con-requerimientos' : 'desfavorable'}">
                    ${tramite.conceptoResultado}
                </p>
            </div>
        ` : '';
        
        content.innerHTML = `
            <h2>Detalle del Tr√°mite: ${tramite.id}</h2>
            <div class="tramite-info">
                <h3>${tramite.nombreComercio}</h3>
                <p><strong>Direcci√≥n:</strong> ${tramite.direccion}</p>
                <p><strong>Tipo de Comercio:</strong> ${this.getTipoComercioLabel(tramite.tipoComercio)}</p>
                <p><strong>Tel√©fono:</strong> ${tramite.telefono}</p>
                <p><strong>Estado:</strong> <span class="status-badge ${tramite.estado}">${this.getEstadoLabel(tramite.estado)}</span></p>
                <p><strong>Progreso:</strong> ${etapasCompletadas} de ${totalEtapas} etapas completadas</p>
            </div>
            
            ${conceptoResultadoHTML}
            
            ${documentosHTML}
            
            <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Trazabilidad del Proceso</h3>
            <div class="timeline-view">
                ${tramite.historial.map((item, index) => {
                    const isCompleted = item.completado;
                    const isActive = !isCompleted && index === tramite.historial.findIndex(h => !h.completado);
                    
                    const fechaStr = item.fecha 
                        ? new Date(item.fecha).toLocaleString('es-CO', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })
                        : 'Pendiente';
                    
                    return `
                        <div class="timeline-item ${isCompleted ? 'completed' : ''}">
                            <div class="timeline-item-content">
                                <div class="timeline-item-header">
                                    <span class="timeline-item-title">${item.etapa}</span>
                                    <span class="timeline-item-date">${fechaStr}</span>
                                </div>
                                <p class="timeline-item-description">${item.descripcion}</p>
                                ${item.inspector ? `<p class="timeline-item-inspector">üë§ Inspector: ${item.inspector}</p>` : ''}
                                ${item.notas ? `<div class="timeline-notes" style="margin-top: 0.75rem; padding: 0.75rem; background: var(--primary-accent); border-radius: 6px; border-left: 3px solid var(--secondary-color);"><strong>üìù Notas:</strong> ${item.notas}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
            
            ${detailActions}
            ${actionsHTML}
        `;
        
        modal.classList.add('active');
    },
    
    exportarTramitePDF(tramiteId) {
        const tramite = this.tramites.find(t => t.id === tramiteId);
        const contenido = `
            TR√ÅMITE: ${tramite.id}
            COMERCIO: ${tramite.nombreComercio}
            DIRECCI√ìN: ${tramite.direccion}
            ESTADO: ${this.getEstadoLabel(tramite.estado)}
            FECHA CREACI√ìN: ${new Date(tramite.fechaCreacion).toLocaleString('es-CO')}
            
            HISTORIAL:
            ${tramite.historial.map(h => `${h.etapa}: ${h.completado ? 'Completado' : 'Pendiente'}`).join('\n')}
        `;
        
        const blob = new Blob([contenido], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tramite_${tramiteId}.txt`;
        a.click();
        this.showNotification('Tr√°mite exportado', 'success');
    },
    
    getEstadoLabel(estado) {
        const estados = {
            'pendiente': 'Pendiente',
            'en-proceso': 'En Proceso',
            'completado': 'Completado',
            'rechazado': 'Rechazado'
        };
        return estados[estado] || estado;
    },
    
    completarEtapa(tramiteId) {
        const tramite = this.tramites.find(t => t.id === tramiteId);
        if (!tramite) return;
        
        const siguienteEtapa = tramite.historial.find(h => !h.completado);
        if (!siguienteEtapa) return;
        
        const notas = document.getElementById('inspectorNotas').value;
        
        siguienteEtapa.completado = true;
        siguienteEtapa.fecha = new Date().toISOString();
        siguienteEtapa.inspector = this.currentUser.email;
        if (notas) {
            siguienteEtapa.notas = notas;
        }
        
        // Actualizar estado del tr√°mite
        if (tramite.estado === 'pendiente') {
            tramite.estado = 'en-proceso';
        }
        
        // Si es la √∫ltima etapa, completar el tr√°mite
        const todasCompletadas = tramite.historial.every(h => h.completado);
        if (todasCompletadas) {
            tramite.estado = 'completado';
        }
        
        this.saveData();
        this.showNotification('Etapa completada exitosamente', 'success');
        this.showTramiteDetail(tramiteId, 'inspector');
        this.renderInspectorTramites(document.querySelector('.filter-tab.active')?.dataset.filter || 'all');
    },
    
    programarVisita(tramiteId) {
        const tramite = this.tramites.find(t => t.id === tramiteId);
        if (!tramite) return;
        
        const etapaVisita = tramite.historial.find(h => h.etapa === 'Visita Programada');
        if (etapaVisita) {
            const fechaVisita = prompt('Ingrese la fecha y hora de la visita (ej: 2024-11-06 10:00)');
            if (fechaVisita) {
                etapaVisita.completado = true;
                etapaVisita.fecha = new Date(fechaVisita).toISOString();
                etapaVisita.inspector = this.currentUser.email;
                etapaVisita.notas = `Visita programada para ${new Date(fechaVisita).toLocaleString('es-CO')}`;
                
                tramite.estado = 'en-proceso';
                this.saveData();
                this.showNotification('Visita programada exitosamente', 'success');
                this.showTramiteDetail(tramiteId, 'inspector');
                this.renderInspectorTramites(document.querySelector('.filter-tab.active')?.dataset.filter || 'all');
            }
        }
    },
    
    finalizarTramite(tramiteId, resultado) {
        const tramite = this.tramites.find(t => t.id === tramiteId);
        if (!tramite) return;
        
        const etapaEmision = tramite.historial.find(h => h.etapa === 'Emisi√≥n de Concepto Sanitario');
        if (etapaEmision) {
            const resultadoTexto = resultado === 'aprobado' ? 'FAVORABLE' : 
                                  resultado === 'requerimientos' ? 'FAVORABLE CON REQUERIMIENTOS' : 'DESFAVORABLE';
            
            etapaEmision.completado = true;
            etapaEmision.fecha = new Date().toISOString();
            etapaEmision.inspector = this.currentUser.email;
            etapaEmision.notas = `Concepto sanitario: ${resultadoTexto}`;
            
            tramite.estado = resultado === 'aprobado' ? 'completado' : 
                           resultado === 'requerimientos' ? 'en-proceso' : 'rechazado';
            tramite.conceptoResultado = resultadoTexto;
            this.saveData();
            this.showNotification(`Concepto sanitario emitido: ${resultadoTexto}`, 'success');
            this.showTramiteDetail(tramiteId, 'inspector');
            this.renderInspectorTramites(document.querySelector('.filter-tab.active')?.dataset.filter || 'all');
        }
    },
    
    getDocumentosRequeridos(tipoComercio) {
        const documentosBasicos = [
            { nombre: 'Certificado de Existencia y Representaci√≥n Legal', requerido: true, categoria: 'legal' },
            { nombre: 'Registro √önico Tributario (RUT)', requerido: true, categoria: 'legal' },
            { nombre: 'Concepto de Uso de Suelo', requerido: true, categoria: 'legal' },
            { nombre: 'Certificado de Fumigaci√≥n o Control de Plagas', requerido: true, categoria: 'sanitario' },
            { nombre: 'An√°lisis de Agua Potable', requerido: true, categoria: 'sanitario' },
            { nombre: 'P√≥liza o Plan de Manejo de Residuos S√≥lidos y L√≠quidos', requerido: true, categoria: 'sanitario' }
        ];
        
        const documentosAlimentos = [
            { nombre: 'Certificado o Carn√© de Salud del Manipulador de Alimentos', requerido: true, categoria: 'personal' },
            { nombre: 'Certificado de Capacitaci√≥n en Buenas Pr√°cticas de Manufactura (BPM)', requerido: true, categoria: 'capacitacion' },
            { nombre: 'Registros Sanitarios del INVIMA (si aplica)', requerido: false, categoria: 'invima' },
            { nombre: 'Lista de Proveedores y Facturas de Compra', requerido: true, categoria: 'trazabilidad' },
            { nombre: 'Plan de Saneamiento B√°sico', requerido: true, categoria: 'operativo' },
            { nombre: 'Manual o Protocolo de Limpieza y Desinfecci√≥n', requerido: true, categoria: 'operativo' }
        ];
        
        const documentosOtros = [
            { nombre: 'Certificados de Aseo y Desinfecci√≥n de Equipos', requerido: true, categoria: 'operativo' },
            { nombre: 'Certificados de Calibraci√≥n de Equipos (si aplica)', requerido: false, categoria: 'equipos' },
            { nombre: 'Protocolos de Bioseguridad', requerido: true, categoria: 'bioseguridad' }
        ];
        
        let documentos = [...documentosBasicos];
        
        if (['restaurante', 'panaderia', 'carniceria', 'supermercado', 'cafeteria', 'tienda'].includes(tipoComercio)) {
            documentos = documentos.concat(documentosAlimentos);
        } else {
            documentos = documentos.concat(documentosOtros);
        }
        
        return documentos.map((doc, index) => ({
            ...doc,
            id: `DOC-${index + 1}`,
            subido: false,
            fechaSubida: null,
            archivo: null
        }));
    },
    
    showNotification(message, type = 'info') {
        // Crear notificaci√≥n temporal
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#3f4d39' : '#4a5d3f'};
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            animation: slideIn 0.3s ease;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
        
        // Guardar notificaci√≥n persistente
        this.addNotification(message, type);
    },
    
    // ========== NUEVAS FUNCIONALIDADES ==========
    
    // Notificaciones persistentes
    loadNotifications() {
        const saved = localStorage.getItem('notifications');
        if (saved) {
            this.notifications = JSON.parse(saved);
        }
    },
    
    saveNotifications() {
        localStorage.setItem('notifications', JSON.stringify(this.notifications));
        this.updateNotificationBadges();
    },
    
    addNotification(message, type = 'info', tramiteId = null) {
        const notification = {
            id: Date.now().toString(),
            message,
            type,
            tramiteId,
            read: false,
            fecha: new Date().toISOString()
        };
        this.notifications.unshift(notification);
        this.saveNotifications();
        
        // Mostrar notificaci√≥n push si est√° disponible
        if (Notification.permission === 'granted') {
            this.showPushNotification('Aeternum Salubris', {
                body: message,
                icon: 'Aesali.png',
                tag: notification.id,
                onClick: () => {
                    if (tramiteId) {
                        this.showTramiteDetail(tramiteId, this.currentUser?.tipo);
                    } else {
                        this.navigateToSection(this.currentUser?.tipo === 'comercio' ? 'notificationsSectionComercio' : 'notificationsSectionInspector');
                    }
                }
            });
        }
    },
    
    updateNotificationBadges() {
        const unread = this.notifications.filter(n => !n.read).length;
        const badgeComercio = document.getElementById('notificationCount');
        const badgeInspector = document.getElementById('notificationCountInspector');
        
        if (badgeComercio) {
            badgeComercio.textContent = unread > 0 ? unread : '';
            badgeComercio.style.display = unread > 0 ? 'flex' : 'none';
        }
        if (badgeInspector) {
            badgeInspector.textContent = unread > 0 ? unread : '';
            badgeInspector.style.display = unread > 0 ? 'flex' : 'none';
        }
    },
    
    showNotificationsModal() {
        const modal = document.getElementById('notificationsModal');
        const list = document.getElementById('notificationsList');
        
        if (this.notifications.length === 0) {
            list.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--gray-500);">No hay notificaciones</p>';
        } else {
            list.innerHTML = this.notifications.map(n => `
                <div class="notification-item ${n.read ? 'read' : 'unread'}" onclick="AppState.markNotificationRead('${n.id}')">
                    <div>${n.message}</div>
                    <div class="notification-date">${new Date(n.fecha).toLocaleString('es-CO')}</div>
                </div>
            `).join('');
        }
        
        modal.classList.add('active');
    },
    
    markNotificationReadById(id) {
        const notification = this.notifications.find(n => n.id === id);
        if (notification) {
            notification.read = true;
            this.saveNotifications();
            this.updateNotificationBadges();
            
            // Actualizar la secci√≥n de notificaciones si est√° activa
            const currentScreen = document.querySelector('.screen.active');
            if (currentScreen && (currentScreen.id === 'notificationsSectionComercio' || currentScreen.id === 'notificationsSectionInspector')) {
                const userType = currentScreen.id === 'notificationsSectionComercio' ? 'comercio' : 'inspector';
                this.renderNotificationsSection(userType);
            }
        }
    },
    
    markNotificationRead(index) {
        // Mantener compatibilidad con c√≥digo existente
        if (index >= 0 && index < this.notifications.length) {
            this.notifications[index].read = true;
            this.saveNotifications();
            this.updateNotificationBadges();
        }
    },
    
    // B√∫squeda y filtros avanzados
    // ========== MEJORAS: B√öSQUEDA AVANZADA ==========
    toggleAdvancedSearch(type) {
        const searchDiv = document.getElementById(`advancedSearch${type === 'comercio' ? 'Comercio' : 'Inspector'}`);
        if (searchDiv) {
            searchDiv.classList.toggle('active');
        }
    },

    applyAdvancedSearch(type) {
        const tipoComercio = document.getElementById('advancedFilterTipoComercio')?.value || '';
        const fechaDesde = document.getElementById('advancedFilterFechaDesde')?.value || '';
        const fechaHasta = document.getElementById('advancedFilterFechaHasta')?.value || '';
        const progreso = document.getElementById('advancedFilterProgreso')?.value || '';
        
        // Guardar filtros
        this.advancedFilters = {
            tipoComercio,
            fechaDesde,
            fechaHasta,
            progreso
        };
        
        // Aplicar filtros y recargar lista
        if (type === 'comercio') {
            this.renderComercioTramites();
            this.renderSavedFilters('comercio');
        } else {
            this.renderInspectorTramites();
            this.renderSavedFilters('inspector');
        }
        
        this.showNotification('Filtros aplicados', 'success');
    },
    
    renderSavedFilters(type) {
        const container = document.getElementById(`savedFiltersList${type === 'comercio' ? 'Comercio' : 'Inspector'}`);
        if (!container) return;
        
        if (this.savedFilters.length === 0) {
            container.innerHTML = '<p style="font-size: 0.875rem; color: var(--text-muted);">No hay filtros guardados</p>';
            return;
        }
        
        container.innerHTML = this.savedFilters.map((filter, index) => `
            <div class="saved-filter-item">
                <div>
                    <div class="saved-filter-name">${filter.name}</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">${new Date(filter.fecha).toLocaleDateString('es-ES')}</div>
                </div>
                <div class="saved-filter-actions">
                    <button class="saved-filter-btn apply" onclick="AppState.applySavedFilter(${JSON.stringify(filter).replace(/"/g, '&quot;')})">Aplicar</button>
                    <button class="saved-filter-btn delete" onclick="AppState.deleteSavedFilter(${index}); AppState.renderSavedFilters('${type}')">Eliminar</button>
                </div>
            </div>
        `).join('');
    },

    clearAdvancedSearch(type) {
        // Limpiar campos
        const tipoComercio = document.getElementById('advancedFilterTipoComercio');
        const fechaDesde = document.getElementById('advancedFilterFechaDesde');
        const fechaHasta = document.getElementById('advancedFilterFechaHasta');
        const progreso = document.getElementById('advancedFilterProgreso');
        
        if (tipoComercio) tipoComercio.value = '';
        if (fechaDesde) fechaDesde.value = '';
        if (fechaHasta) fechaHasta.value = '';
        if (progreso) progreso.value = '';
        
        this.advancedFilters = {};
        
        if (type === 'comercio') {
            this.renderComercioTramites();
        } else {
            this.renderInspectorTramites();
        }
        
        this.showNotification('Filtros limpiados', 'info');
    },

    // Vista previa de documentos
    previewDocumentByIndex(index, tramiteId) {
        const tramite = this.tramites.find(t => t.id === tramiteId);
        if (!tramite || !tramite.documentos || !tramite.documentos[index]) {
            this.showNotification('Documento no encontrado', 'error');
            return;
        }
        
        const documento = tramite.documentos[index];
        this.previewDocument(documento, tramiteId);
    },

    previewDocument(documento, tramiteId) {
        const preview = document.createElement('div');
        preview.className = 'document-preview';
        preview.innerHTML = `
            <div class="document-preview-content">
                <div class="document-preview-header">
                    <h3>${documento.nombre || documento.nombreDocumento}</h3>
                    <button class="document-preview-close" onclick="this.closest('.document-preview').remove()">Cerrar</button>
                </div>
                <div class="document-preview-body">
                    ${documento.contenido ? `
                        ${documento.tipo?.includes('pdf') ? `
                            <iframe src="${documento.contenido}" class="document-preview-iframe"></iframe>
                        ` : documento.tipo?.includes('image') ? `
                            <img src="${documento.contenido}" style="max-width: 100%; height: auto;" alt="${documento.nombre}" />
                        ` : `
                            <p>Vista previa no disponible para este tipo de archivo.</p>
                            <a href="${documento.contenido}" download="${documento.nombre || documento.nombreDocumento}" class="btn btn-primary">Descargar</a>
                        `}
                    ` : '<p>No hay contenido disponible para previsualizar.</p>'}
                </div>
            </div>
        `;
        document.body.appendChild(preview);
        
        // Cerrar con Escape
        const closeHandler = (e) => {
            if (e.key === 'Escape') {
                preview.remove();
                document.removeEventListener('keydown', closeHandler);
            }
        };
        document.addEventListener('keydown', closeHandler);
    },

    setupSearchAndFilters() {
        const searchComercio = document.getElementById('searchInputComercio');
        const searchInspector = document.getElementById('searchInputInspector');
        const sortComercio = document.getElementById('sortByComercio');
        const sortInspector = document.getElementById('sortByInspector');
        const filterEstadoComercio = document.getElementById('filterEstadoComercio');
        const filterEstadoInspector = document.getElementById('filterEstadoInspector');
        const filterFechaInspector = document.getElementById('filterFechaInspector');
        
        if (searchComercio) {
            searchComercio.addEventListener('input', () => this.filterAndRenderComercio());
        }
        if (searchInspector) {
            searchInspector.addEventListener('input', () => this.filterAndRenderInspector());
        }
        if (sortComercio) {
            sortComercio.addEventListener('change', () => this.filterAndRenderComercio());
        }
        if (sortInspector) {
            sortInspector.addEventListener('change', () => this.filterAndRenderInspector());
        }
        if (filterEstadoComercio) {
            filterEstadoComercio.addEventListener('change', () => this.filterAndRenderComercio());
        }
        if (filterEstadoInspector) {
            filterEstadoInspector.addEventListener('change', () => this.filterAndRenderInspector());
        }
        if (filterFechaInspector) {
            filterFechaInspector.addEventListener('change', () => this.filterAndRenderInspector());
        }
    },
    
    filterAndRenderComercio() {
        const searchTerm = document.getElementById('searchInputComercio')?.value.toLowerCase() || '';
        const estadoFilter = document.getElementById('filterEstadoComercio')?.value || 'all';
        const sortBy = document.getElementById('sortByComercio')?.value || 'fecha-desc';
        
        let filtered = this.tramites.filter(t => t.comercioId === this.currentUser.email);
        
        // B√∫squeda b√°sica
        if (searchTerm) {
            filtered = filtered.filter(t => 
                t.nombreComercio.toLowerCase().includes(searchTerm) ||
                t.id.toLowerCase().includes(searchTerm) ||
                t.direccion.toLowerCase().includes(searchTerm)
            );
        }
        
        // Filtro por estado
        if (estadoFilter !== 'all') {
            filtered = filtered.filter(t => t.estado === estadoFilter);
        }
        
        // Filtros avanzados
        if (this.advancedFilters) {
            if (this.advancedFilters.tipoComercio) {
                filtered = filtered.filter(t => t.tipoComercio === this.advancedFilters.tipoComercio);
            }
            if (this.advancedFilters.fechaDesde) {
                filtered = filtered.filter(t => new Date(t.fechaCreacion) >= new Date(this.advancedFilters.fechaDesde));
            }
            if (this.advancedFilters.fechaHasta) {
                filtered = filtered.filter(t => new Date(t.fechaCreacion) <= new Date(this.advancedFilters.fechaHasta));
            }
            if (this.advancedFilters.progreso) {
                const [min, max] = this.advancedFilters.progreso.split('-').map(Number);
                filtered = filtered.filter(t => {
                    const completadas = t.historial?.filter(h => h.completado).length || 0;
                    const total = t.historial?.length || 1;
                    const porcentaje = (completadas / total) * 100;
                    return porcentaje >= min && porcentaje <= max;
                });
            }
        }
        
        // Ordenamiento
        filtered.sort((a, b) => {
            switch(sortBy) {
                case 'fecha-desc': return new Date(b.fechaCreacion) - new Date(a.fechaCreacion);
                case 'fecha-asc': return new Date(a.fechaCreacion) - new Date(b.fechaCreacion);
                case 'nombre': return a.nombreComercio.localeCompare(b.nombreComercio);
                case 'estado': return a.estado.localeCompare(b.estado);
                default: return 0;
            }
        });
        
        this.renderTramitesWithPagination(filtered, 'comercio');
    },
    
    filterAndRenderInspector() {
        const searchTerm = document.getElementById('searchInputInspector')?.value.toLowerCase() || '';
        const estadoFilter = document.getElementById('filterEstadoInspector')?.value || 'all';
        const fechaFilter = document.getElementById('filterFechaInspector')?.value || '';
        const sortBy = document.getElementById('sortByInspector')?.value || 'fecha-desc';
        
        let filtered = [...this.tramites];
        
        // B√∫squeda
        if (searchTerm) {
            filtered = filtered.filter(t => 
                t.nombreComercio.toLowerCase().includes(searchTerm) ||
                t.id.toLowerCase().includes(searchTerm) ||
                t.direccion.toLowerCase().includes(searchTerm)
            );
        }
        
        // Filtro por estado
        if (estadoFilter !== 'all') {
            filtered = filtered.filter(t => t.estado === estadoFilter);
        }
        
        // Filtro por fecha
        if (fechaFilter) {
            filtered = filtered.filter(t => {
                const fecha = new Date(t.fechaCreacion).toISOString().split('T')[0];
                return fecha === fechaFilter;
            });
        }
        
        // Ordenamiento
        filtered.sort((a, b) => {
            switch(sortBy) {
                case 'fecha-desc': return new Date(b.fechaCreacion) - new Date(a.fechaCreacion);
                case 'fecha-asc': return new Date(a.fechaCreacion) - new Date(b.fechaCreacion);
                case 'nombre': return a.nombreComercio.localeCompare(b.nombreComercio);
                case 'estado': return a.estado.localeCompare(b.estado);
                default: return 0;
            }
        });
        
        this.renderTramitesWithPagination(filtered, 'inspector');
    },
    
    renderTramitesWithPagination(tramites, type) {
        const container = type === 'comercio' 
            ? document.getElementById('tramitesList')
            : document.getElementById('inspectorTramitesList');
        const paginationEl = type === 'comercio'
            ? document.getElementById('paginationComercio')
            : document.getElementById('paginationInspector');
        const currentPage = type === 'comercio' ? this.currentPageComercio : this.currentPageInspector;
        
        if (tramites.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"></div><h3>No se encontraron tr√°mites</h3></div>';
            paginationEl.innerHTML = '';
            return;
        }
        
        const totalPages = Math.ceil(tramites.length / this.itemsPerPage);
        const start = (currentPage - 1) * this.itemsPerPage;
        const end = start + this.itemsPerPage;
        const pageTramites = tramites.slice(start, end);
        
        container.innerHTML = pageTramites.map(t => this.createTramiteCard(t)).join('');
        
        // Event listeners
        container.querySelectorAll('.tramite-card').forEach(card => {
            card.addEventListener('click', () => {
                const tramiteId = card.dataset.id;
                this.showTramiteDetail(tramiteId, type);
            });
        });
        
        // Paginaci√≥n
        this.renderPagination(paginationEl, currentPage, totalPages, type);
    },
    
    renderPagination(container, currentPage, totalPages, type) {
        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }
        
        let html = '';
        if (currentPage > 1) {
            html += `<button onclick="AppState.changePage(${currentPage - 1}, '${type}')">Anterior</button>`;
        }
        
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                html += `<button class="${i === currentPage ? 'active' : ''}" onclick="AppState.changePage(${i}, '${type}')">${i}</button>`;
            } else if (i === currentPage - 2 || i === currentPage + 2) {
                html += `<span>...</span>`;
            }
        }
        
        if (currentPage < totalPages) {
            html += `<button onclick="AppState.changePage(${currentPage + 1}, '${type}')">Siguiente</button>`;
        }
        
        container.innerHTML = html;
    },
    
    changePage(page, type) {
        if (type === 'comercio') {
            this.currentPageComercio = page;
            this.filterAndRenderComercio();
        } else {
            this.currentPageInspector = page;
            this.filterAndRenderInspector();
        }
    },
    
    // Perfil de usuario
    
    // Estad√≠sticas
    showStatsModal() {
        const modal = document.getElementById('statsModal');
        const total = this.tramites.length;
        const pendientes = this.tramites.filter(t => t.estado === 'pendiente').length;
        const enProceso = this.tramites.filter(t => t.estado === 'en-proceso').length;
        const completados = this.tramites.filter(t => t.estado === 'completado').length;
        
        document.getElementById('statTotal').textContent = total;
        document.getElementById('statPendientes').textContent = pendientes;
        document.getElementById('statEnProceso').textContent = enProceso;
        document.getElementById('statCompletados').textContent = completados;
        
        // Gr√°fico
        setTimeout(() => {
            const ctx = document.getElementById('estadosChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Pendientes', 'En Proceso', 'Completados', 'Rechazados'],
                        datasets: [{
                            data: [
                                pendientes,
                                enProceso,
                                completados,
                                this.tramites.filter(t => t.estado === 'rechazado').length
                            ],
                            backgroundColor: ['#d4a574', '#3f4d39', '#6b8e5a', '#c85a4a']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
        }, 100);
        
        modal.classList.add('active');
    },
    
    exportarReporte(format = 'json') {
        const tramites = this.currentUser?.tipo === 'inspector' 
            ? this.tramites 
            : this.tramites.filter(t => t.comercioId === this.currentUser?.email);
        
        if (format === 'csv') {
            this.exportarCSV(tramites);
        } else if (format === 'pdf') {
            this.exportarPDF(tramites);
        } else {
            // JSON por defecto
            const data = {
                fecha: new Date().toISOString(),
                usuario: this.currentUser?.email,
                total: tramites.length,
                pendientes: tramites.filter(t => t.estado === 'pendiente').length,
                enProceso: tramites.filter(t => t.estado === 'en-proceso').length,
                completados: tramites.filter(t => t.estado === 'completado').length,
                tramites: tramites.map(t => ({
                    id: t.id,
                    nombreComercio: t.nombreComercio,
                    direccion: t.direccion,
                    tipoComercio: t.tipoComercio,
                    estado: t.estado,
                    fechaCreacion: t.fechaCreacion
                }))
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            this.showNotification('Reporte exportado', 'success');
        }
    },

    exportarCSV(tramites) {
        const headers = ['ID', 'Comercio', 'Direcci√≥n', 'Tipo', 'Estado', 'Fecha Creaci√≥n', 'Tel√©fono'];
        const rows = tramites.map(t => [
            t.id,
            `"${t.nombreComercio}"`,
            `"${t.direccion}"`,
            t.tipoComercio,
            t.estado,
            new Date(t.fechaCreacion).toLocaleDateString('es-ES'),
            t.telefono || ''
        ]);
        
        const csvContent = [
            headers.join(','),
            ...rows.map(row => row.join(','))
        ].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `reporte_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        this.showNotification('Reporte CSV exportado', 'success');
    },

    exportarPDF(tramites) {
        // Crear contenido HTML para PDF
        const htmlContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Reporte de Tr√°mites</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    h1 { color: #2d5a3d; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    th { background-color: #2d5a3d; color: white; }
                    tr:nth-child(even) { background-color: #f2f2f2; }
                </style>
            </head>
            <body>
                <h1>Reporte de Tr√°mites Sanitarios</h1>
                <p><strong>Fecha:</strong> ${new Date().toLocaleDateString('es-ES')}</p>
                <p><strong>Total de Tr√°mites:</strong> ${tramites.length}</p>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Comercio</th>
                            <th>Direcci√≥n</th>
                            <th>Tipo</th>
                            <th>Estado</th>
                            <th>Fecha Creaci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tramites.map(t => `
                            <tr>
                                <td>${t.id}</td>
                                <td>${t.nombreComercio}</td>
                                <td>${t.direccion}</td>
                                <td>${t.tipoComercio}</td>
                                <td>${t.estado}</td>
                                <td>${new Date(t.fechaCreacion).toLocaleDateString('es-ES')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </body>
            </html>
        `;
        
        // Abrir ventana para imprimir/guardar como PDF
        const printWindow = window.open('', '_blank');
        printWindow.document.write(htmlContent);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => {
            printWindow.print();
        }, 250);
        this.showNotification('Preparando PDF... Usa la funci√≥n de impresi√≥n de tu navegador', 'info');
    },
    
    imprimirReporte() {
        window.print();
    },
    
    // Calendario
    showCalendarModal() {
        const modal = document.getElementById('calendarModal');
        const now = new Date();
        this.currentCalendarMonth = now.getMonth();
        this.currentCalendarYear = now.getFullYear();
        this.renderCalendar();
        modal.classList.add('active');
    },
    
    renderCalendar() {
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        const grid = document.getElementById('calendarGrid');
        const monthHeader = document.getElementById('currentMonth');
        
        if (!grid || !monthHeader) return;
        
        monthHeader.textContent = `${monthNames[this.currentCalendarMonth]} ${this.currentCalendarYear}`;
        
        const firstDay = new Date(this.currentCalendarYear, this.currentCalendarMonth, 1);
        const lastDay = new Date(this.currentCalendarYear, this.currentCalendarMonth + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        
        const days = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
        let html = days.map(d => `<div class="calendar-day-header">${d}</div>`).join('');
        
        // D√≠as vac√≠os al inicio
        for (let i = 0; i < startingDayOfWeek; i++) {
            html += '<div class="calendar-day"></div>';
        }
        
        // D√≠as del mes
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(this.currentCalendarYear, this.currentCalendarMonth, day);
            const dateStr = date.toISOString().split('T')[0];
            const hasVisit = this.tramites.some(t => {
                return t.historial.some(h => h.fecha && h.fecha.split('T')[0] === dateStr);
            });
            const isToday = date.toDateString() === today.toDateString();
            
            html += `<div class="calendar-day ${hasVisit ? 'has-visit' : ''} ${isToday ? 'today' : ''}" onclick="AppState.showDayVisits('${dateStr}')">${day}</div>`;
        }
        
        grid.innerHTML = html;
    },
    
    showDayVisits(dateStr) {
        const visits = this.tramites.filter(t => 
            t.historial.some(h => h.fecha && h.fecha.split('T')[0] === dateStr)
        );
        
        if (visits.length === 0) {
            alert('No hay visitas programadas para este d√≠a');
        } else {
            alert(`Visitas programadas: ${visits.length}\n${visits.map(t => `- ${t.nombreComercio} (${t.id})`).join('\n')}`);
        }
    },
    
    // Chat/Mensajer√≠a
    showChatModal(tramiteId) {
        const modal = document.getElementById('chatModal');
        this.currentTramiteChat = tramiteId;
        const tramite = this.tramites.find(t => t.id === tramiteId);
        
        if (!tramite.mensajes) {
            tramite.mensajes = [];
        }
        
        this.renderChat(tramite.mensajes);
        modal.classList.add('active');
    },
    
    renderChat(mensajes) {
        const container = document.getElementById('chatMessages');
        if (mensajes.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 2rem;">No hay mensajes a√∫n</p>';
            return;
        }
        
        container.innerHTML = mensajes.map(m => `
            <div class="message ${m.remitente === this.currentUser.email ? 'sent' : 'received'}">
                <div class="message-header">${m.remitente === this.currentUser.email ? 'T√∫' : (m.remitente.includes('comercio') ? 'Comercio' : 'Inspector')}</div>
                <div>${m.texto}</div>
                <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;">${new Date(m.fecha).toLocaleString('es-CO')}</div>
            </div>
        `).join('');
        
        container.scrollTop = container.scrollHeight;
    },
    
    sendMessage() {
        const input = document.getElementById('chatInput');
        const texto = input.value.trim();
        
        if (!texto || !this.currentTramiteChat) return;
        
        const tramite = this.tramites.find(t => t.id === this.currentTramiteChat);
        if (!tramite.mensajes) {
            tramite.mensajes = [];
        }
        
        tramite.mensajes.push({
            remitente: this.currentUser.email,
            texto,
            fecha: new Date().toISOString()
        });
        
        this.saveData();
        this.renderChat(tramite.mensajes);
        input.value = '';
        
        // Notificar al otro usuario
        const otroUsuario = tramite.comercioId === this.currentUser.email 
            ? 'inspector@demo.com' 
            : tramite.comercioId;
        this.addNotification(`Nuevo mensaje en tr√°mite ${tramite.id}`, 'info', tramite.id);
    },
    
    // Documentos
    showDocumentsModal(tramiteId) {
        const modal = document.getElementById('documentsModal');
        const tramite = this.tramites.find(t => t.id === tramiteId);
        this.currentTramiteDocuments = tramiteId;
        
        if (!tramite.documentos) {
            tramite.documentos = [];
        }
        
        if (!tramite.documentosRequeridos) {
            tramite.documentosRequeridos = this.getDocumentosRequeridos(tramite.tipoComercio);
        }
        
        // Mostrar/ocultar secci√≥n de subida seg√∫n el tipo de usuario
        const uploadSection = document.getElementById('uploadSection');
        if (uploadSection) {
            uploadSection.style.display = this.currentUser?.tipo === 'comercio' ? 'block' : 'none';
        }
        
        this.renderDocuments(tramite);
        modal.classList.add('active');
    },
    
    renderDocuments(tramite) {
        const container = document.getElementById('documentsList');
        const isInspector = this.currentUser?.tipo === 'inspector';
        
        // Agrupar documentos requeridos por categor√≠a
        const documentosPorCategoria = {};
        if (tramite.documentosRequeridos) {
            tramite.documentosRequeridos.forEach(doc => {
                if (!documentosPorCategoria[doc.categoria]) {
                    documentosPorCategoria[doc.categoria] = [];
                }
                documentosPorCategoria[doc.categoria].push(doc);
            });
        }
        
        let html = '';
        
        // Mostrar documentos requeridos organizados por categor√≠a
        Object.keys(documentosPorCategoria).forEach(categoria => {
            html += `<h4 style="margin-top: 1.5rem; margin-bottom: 0.75rem; color: var(--primary-color); font-weight: 600;">${this.getCategoriaLabel(categoria)}</h4>`;
            html += '<div class="checklist" style="margin-bottom: 1rem;">';
            
            documentosPorCategoria[categoria].forEach((doc, docIndex) => {
                const documentoSubido = tramite.documentos?.find(d => d.documentoRequeridoId === doc.id);
                const docId = doc.id;
                const uniqueInputId = `fileUpload_${tramite.id}_${docId}`;
                
                // Estado de aprobaci√≥n del documento
                const estadoAprobacion = documentoSubido?.estadoAprobacion || 'pendiente';
                const observaciones = documentoSubido?.observaciones || '';
                
                if (isInspector) {
                    // Vista del inspector: aprobar/rechazar
                    html += `
                        <div class="document-item-requerido ${documentoSubido ? (estadoAprobacion === 'aprobado' ? 'approved' : estadoAprobacion === 'rechazado' ? 'rejected' : 'pending') : 'no-subido'}">
                            <div class="document-item-header">
                                <div class="document-item-info">
                                    <span class="checklist-icon">${documentoSubido ? 
                                        (estadoAprobacion === 'aprobado' ? '‚úì' : estadoAprobacion === 'rechazado' ? '‚úó' : '‚óã') 
                                        : '‚óã'}</span>
                                    <div style="flex: 1; margin-left: 0.75rem;">
                                        <strong>${doc.nombre}</strong>
                                        <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                            ${doc.requerido ? '<span class="checklist-requerido">Requerido</span>' : '<span class="checklist-opcional">Opcional</span>'}
                                            <span class="checklist-categoria">${this.getCategoriaLabel(doc.categoria)}</span>
                                            ${documentoSubido ? `
                                                <span style="font-size: 0.875rem; color: var(--gray-600);">
                                                    Subido: ${new Date(documentoSubido.fecha).toLocaleDateString('es-CO')} | ${documentoSubido.tama√±o || 'N/A'}
                                                </span>
                                                ${estadoAprobacion !== 'pendiente' ? `
                                                    <span class="document-status ${estadoAprobacion}">
                                                        ${estadoAprobacion === 'aprobado' ? 'Aprobado' : 'Rechazado'}
                                                    </span>
                                                ` : '<span class="document-status pending">Pendiente de revisi√≥n</span>'}
                                            ` : '<span style="font-size: 0.875rem; color: var(--danger-color);">No subido</span>'}
                                        </div>
                                        ${observaciones ? `<div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(245, 158, 11, 0.1); border-radius: 6px; font-size: 0.875rem; color: var(--warning-color);"><strong>Observaciones:</strong> ${observaciones}</div>` : ''}
                                    </div>
                                </div>
                                <div class="document-item-actions">
                                    ${documentoSubido ? `
                                        <button class="btn btn-sm btn-primary" onclick="AppState.previewDocumentByIndex(${tramite.documentos.indexOf(documentoSubido)}, '${tramite.id}')" style="margin-right: 0.5rem;">
                                            üëÅÔ∏è Ver
                                        </button>
                                        <button class="btn btn-sm btn-secondary" onclick="AppState.downloadDocumentByIndex(${tramite.documentos.indexOf(documentoSubido)})" style="margin-right: 0.5rem;">
                                            üì• Descargar
                                        </button>
                                        ${estadoAprobacion !== 'aprobado' ? `
                                            <button class="btn btn-sm btn-success" onclick="AppState.aprobarDocumento('${tramite.id}', '${docId}')" style="margin-right: 0.5rem;">
                                                Aprobar
                                            </button>
                                        ` : ''}
                                        ${estadoAprobacion !== 'rechazado' ? `
                                            <button class="btn btn-sm btn-danger" onclick="AppState.rechazarDocumento('${tramite.id}', '${docId}')">
                                                Rechazar
                                            </button>
                                        ` : ''}
                                    ` : `
                                        <span style="font-size: 0.875rem; color: var(--gray-500);">Esperando documento</span>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Vista del comercio: subir documentos
                    html += `
                        <div class="document-item-requerido ${documentoSubido ? 'completed' : ''}">
                            <div class="document-item-header">
                                <div class="document-item-info">
                                    <span class="checklist-icon">${documentoSubido ? '‚úì' : '‚óã'}</span>
                                    <div style="flex: 1; margin-left: 0.75rem;">
                                        <strong>${doc.nombre}</strong>
                                        <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                            ${doc.requerido ? '<span class="checklist-requerido">Requerido</span>' : '<span class="checklist-opcional">Opcional</span>'}
                                            <span class="checklist-categoria">${this.getCategoriaLabel(doc.categoria)}</span>
                                            ${documentoSubido ? `<span style="font-size: 0.875rem; color: var(--gray-600);">Subido: ${new Date(documentoSubido.fecha).toLocaleDateString('es-CO')} | ${documentoSubido.tama√±o || 'N/A'}</span>` : ''}
                                            ${documentoSubido && documentoSubido.estadoAprobacion ? `
                                                <span class="document-status ${documentoSubido.estadoAprobacion}">
                                                    ${documentoSubido.estadoAprobacion === 'aprobado' ? 'Aprobado' : documentoSubido.estadoAprobacion === 'rechazado' ? 'Rechazado' : 'Pendiente'}
                                                </span>
                                            ` : ''}
                                        </div>
                                        ${documentoSubido && documentoSubido.observaciones ? `<div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(245, 158, 11, 0.1); border-radius: 6px; font-size: 0.875rem; color: var(--warning-color);"><strong>Observaciones del inspector:</strong> ${documentoSubido.observaciones}</div>` : ''}
                                    </div>
                                </div>
                                <div class="document-item-actions">
                                    ${documentoSubido ? `
                                        <button class="btn btn-sm btn-primary" onclick="AppState.previewDocumentByIndex(${tramite.documentos.indexOf(documentoSubido)}, '${tramite.id}')" style="margin-right: 0.5rem;">
                                            üëÅÔ∏è Ver
                                        </button>
                                        <button class="btn btn-sm btn-secondary" onclick="AppState.downloadDocumentByIndex(${tramite.documentos.indexOf(documentoSubido)})" style="margin-right: 0.5rem;">
                                            üì• Descargar
                                        </button>
                                        <label for="${uniqueInputId}" class="btn btn-sm btn-primary" style="cursor: pointer; margin: 0;">
                                            Reemplazar
                                            <input type="file" id="${uniqueInputId}" style="display: none;" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" onchange="AppState.uploadDocumentForItem('${tramite.id}', '${docId}', this.files[0])">
                                        </label>
                                    ` : `
                                        <label for="${uniqueInputId}" class="btn btn-sm btn-primary" style="cursor: pointer; margin: 0;">
                                            Subir
                                            <input type="file" id="${uniqueInputId}" style="display: none;" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" onchange="AppState.uploadDocumentForItem('${tramite.id}', '${docId}', this.files[0])">
                                        </label>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
        });
        
        // Mostrar documentos adicionales solo para comercio
        if (!isInspector && tramite.documentos && tramite.documentos.length > 0) {
            const documentosAdicionales = tramite.documentos.filter(d => 
                !tramite.documentosRequeridos?.some(dr => dr.id === d.documentoRequeridoId) && !d.documentoRequeridoId
            );
            
            if (documentosAdicionales.length > 0) {
                html += `<h4 style="margin-top: 2rem; margin-bottom: 0.75rem; color: var(--primary-color); font-weight: 600;">Documentos Adicionales</h4>`;
                html += documentosAdicionales.map((doc, index) => {
                    const docIndex = tramite.documentos.indexOf(doc);
                    return `
                        <div class="document-item">
                            <div class="document-item-info">
                                <div class="document-item-name">${doc.nombre || doc.nombreDocumento}</div>
                                <div class="document-item-meta">Subido: ${new Date(doc.fecha).toLocaleString('es-CO')} | Tama√±o: ${doc.tama√±o || 'N/A'}</div>
                            </div>
                            <button class="btn btn-sm btn-secondary" onclick="AppState.downloadDocument(${docIndex})">Descargar</button>
                        </div>
                    `;
                }).join('');
            }
        }
        
        if (html === '') {
            html = '<p style="text-align: center; padding: 2rem; color: var(--gray-500);">No hay documentos requeridos para este tipo de comercio</p>';
        }
        
        container.innerHTML = html;
    },
    
    uploadDocumentForItem(tramiteId, documentoRequeridoId, file) {
        if (!file) {
            this.showNotification('Por favor selecciona un archivo', 'warning');
            return;
        }
        
        const tramite = this.tramites.find(t => t.id === tramiteId);
        if (!tramite) {
            this.showNotification('Error: Tr√°mite no encontrado', 'error');
            return;
        }
        
        if (!tramite.documentos) {
            tramite.documentos = [];
        }
        
        // Buscar si ya existe un documento para este requerido
        const existingDocIndex = tramite.documentos.findIndex(d => d.documentoRequeridoId === documentoRequeridoId);
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const nuevoDocumento = {
                nombre: file.name,
                nombreDocumento: file.name,
                documentoRequeridoId: documentoRequeridoId,
                tipo: file.type,
                tama√±o: (file.size / 1024).toFixed(2) + ' KB',
                contenido: e.target.result,
                fecha: new Date().toISOString()
            };
            
            if (existingDocIndex >= 0) {
                // Reemplazar documento existente
                tramite.documentos[existingDocIndex] = nuevoDocumento;
                this.showNotification('Documento reemplazado exitosamente', 'success');
            } else {
                // Agregar nuevo documento
                tramite.documentos.push(nuevoDocumento);
                this.showNotification('Documento subido exitosamente', 'success');
            }
            
            // Actualizar estado del documento requerido
            if (tramite.documentosRequeridos) {
                const docRequerido = tramite.documentosRequeridos.find(dr => dr.id === documentoRequeridoId);
                if (docRequerido) {
                    docRequerido.subido = true;
                    docRequerido.fechaSubida = new Date().toISOString();
                    docRequerido.archivo = file.name;
                }
            }
            
            this.saveData();
            this.renderDocuments(tramite);
        };
        
        reader.onerror = () => {
            this.showNotification(`Error al leer el archivo: ${file.name}`, 'error');
        };
        
        reader.readAsDataURL(file);
    },
    
    uploadDocument() {
        const input = document.getElementById('fileUpload');
        const files = input.files;
        
        if (!files || files.length === 0) {
            this.showNotification('Por favor selecciona al menos un archivo', 'warning');
            return;
        }
        
        if (!this.currentTramiteDocuments) {
            this.showNotification('Error: No hay tr√°mite seleccionado', 'error');
            return;
        }
        
        const tramite = this.tramites.find(t => t.id === this.currentTramiteDocuments);
        if (!tramite) {
            this.showNotification('Error: Tr√°mite no encontrado', 'error');
            return;
        }
        
        if (!tramite.documentos) {
            tramite.documentos = [];
        }
        
        let filesProcessed = 0;
        const totalFiles = files.length;
        
        Array.from(files).forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                tramite.documentos.push({
                    nombre: file.name,
                    nombreDocumento: file.name,
                    tipo: file.type,
                    tama√±o: (file.size / 1024).toFixed(2) + ' KB',
                    contenido: e.target.result,
                    fecha: new Date().toISOString()
                });
                
                filesProcessed++;
                
                if (filesProcessed === totalFiles) {
                    this.saveData();
                    this.renderDocuments(tramite);
                    this.showNotification(`${totalFiles} documento(s) adicional(es) subido(s) exitosamente`, 'success');
                    input.value = '';
                    document.getElementById('selectedFiles').textContent = '';
                }
            };
            
            reader.onerror = () => {
                this.showNotification(`Error al leer el archivo: ${file.name}`, 'error');
            };
            
            reader.readAsDataURL(file);
        });
    },
    
    downloadDocumentByIndex(index) {
        const tramite = this.tramites.find(t => t.id === this.currentTramiteDocuments);
        if (!tramite || !tramite.documentos[index]) return;
        
        const doc = tramite.documentos[index];
        const a = document.createElement('a');
        a.href = doc.contenido;
        a.download = doc.nombre || doc.nombreDocumento;
        a.click();
    },
    
    downloadDocument(index) {
        this.downloadDocumentByIndex(index);
    },
    
    aprobarDocumento(tramiteId, documentoRequeridoId) {
        const tramite = this.tramites.find(t => t.id === tramiteId);
        if (!tramite) return;
        
        const documento = tramite.documentos?.find(d => d.documentoRequeridoId === documentoRequeridoId);
        if (!documento) {
            this.showNotification('No se encontr√≥ el documento', 'error');
            return;
        }
        
        documento.estadoAprobacion = 'aprobado';
        documento.fechaRevision = new Date().toISOString();
        documento.revisor = this.currentUser.email;
        documento.observaciones = '';
        
        // Actualizar estado del documento requerido
        if (tramite.documentosRequeridos) {
            const docRequerido = tramite.documentosRequeridos.find(dr => dr.id === documentoRequeridoId);
            if (docRequerido) {
                docRequerido.aprobado = true;
            }
        }
        
        this.saveData();
        this.renderDocuments(tramite);
        this.showNotification('Documento aprobado exitosamente', 'success');
        
        // Notificar al comercio
        this.addNotification(`Tu documento "${documento.nombreDocumento || documento.nombre}" ha sido aprobado`, 'success', tramiteId);
    },
    
    rechazarDocumento(tramiteId, documentoRequeridoId) {
        const tramite = this.tramites.find(t => t.id === tramiteId);
        if (!tramite) return;
        
        const documento = tramite.documentos?.find(d => d.documentoRequeridoId === documentoRequeridoId);
        if (!documento) {
            this.showNotification('No se encontr√≥ el documento', 'error');
            return;
        }
        
        const observaciones = prompt('Ingresa las observaciones o motivos del rechazo:');
        if (observaciones === null) return; // Usuario cancel√≥
        
        documento.estadoAprobacion = 'rechazado';
        documento.fechaRevision = new Date().toISOString();
        documento.revisor = this.currentUser.email;
        documento.observaciones = observaciones || 'Documento rechazado por el inspector';
        
        // Actualizar estado del documento requerido
        if (tramite.documentosRequeridos) {
            const docRequerido = tramite.documentosRequeridos.find(dr => dr.id === documentoRequeridoId);
            if (docRequerido) {
                docRequerido.aprobado = false;
            }
        }
        
        this.saveData();
        this.renderDocuments(tramite);
        this.showNotification('Documento rechazado. Las observaciones han sido registradas', 'warning');
        
        // Notificar al comercio
        this.addNotification(`Tu documento "${documento.nombreDocumento || documento.nombre}" ha sido rechazado. Revisa las observaciones.`, 'error', tramiteId);
    },
    
    // Mapa
    showMapModal(tramiteId) {
        const modal = document.getElementById('mapModal');
        const tramite = this.tramites.find(t => t.id === tramiteId);
        
        if (!tramite) return;
        
        const direccion = tramite.direccion;
        document.getElementById('mapAddress').textContent = direccion;
        
        // Limpiar el contenedor del mapa
        const mapContainer = document.getElementById('mapContainer');
        
        // Crear iframe con Google Maps Embed API
        const encodedAddress = encodeURIComponent(direccion + ', Colombia');
        const mapUrl = `https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6d_s6H4pY0nYz4U&q=${encodedAddress}&zoom=15`;
        
        // Usar OpenStreetMap como alternativa gratuita (no requiere API key)
        const osmUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${this.getBoundingBox(direccion)}&layer=mapnik&marker=${encodeURIComponent(direccion)}`;
        
        // Usar Google Maps Embed sin API key (versi√≥n simplificada)
        const googleMapsUrl = `https://www.google.com/maps?q=${encodedAddress}&output=embed`;
        
        mapContainer.innerHTML = `
            <div style="position: relative; width: 100%; height: 100%; border-radius: 8px; overflow: hidden;">
                <iframe 
                    width="100%" 
                    height="100%" 
                    style="border:0; border-radius: 8px;" 
                    loading="lazy" 
                    allowfullscreen
                    referrerpolicy="no-referrer-when-downgrade"
                    src="${googleMapsUrl}">
                </iframe>
                <div style="position: absolute; bottom: 10px; right: 10px; background: rgba(255,255,255,0.9); padding: 8px 12px; border-radius: 6px; font-size: 0.875rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                    <a href="https://www.google.com/maps/search/?api=1&query=${encodedAddress}" target="_blank" style="color: var(--primary-color); text-decoration: none; font-weight: 500;">
                        Abrir en Google Maps ‚Üí
                    </a>
                </div>
            </div>
        `;
        
        modal.classList.add('active');
    },
    
    getBoundingBox(direccion) {
        // Coordenadas aproximadas para Bogot√° (ajustar seg√∫n necesidad)
        // Esto es un placeholder, en producci√≥n se usar√≠a geocodificaci√≥n
        const defaultBbox = '-74.2,4.5,-74.0,4.7';
        return defaultBbox;
    },
    
    // Recordatorios
    checkReminders() {
        // Verificar recordatorios de visitas pr√≥ximas
        const hoy = new Date();
        const ma√±ana = new Date(hoy);
        ma√±ana.setDate(ma√±ana.getDate() + 1);
        
        this.tramites.forEach(tramite => {
            tramite.historial.forEach(etapa => {
                if (etapa.fecha && etapa.etapa === 'Visita Programada') {
                    const fechaVisita = new Date(etapa.fecha);
                    if (fechaVisita >= hoy && fechaVisita <= ma√±ana) {
                        this.addNotification(`Recordatorio: Visita programada para ${tramite.nombreComercio} ma√±ana`, 'info', tramite.id);
                    }
                }
            });
        });
    },
    
    // Actualizar setupEventListeners para incluir nuevas funciones
    setupNewEventListeners() {
        // Los botones de notificaciones ya est√°n manejados en setupEventListeners para navegar a secciones
        
        
        // Los botones de navegaci√≥n ya est√°n manejados en setupEventListeners
        document.getElementById('prevMonth')?.addEventListener('click', () => {
            this.currentCalendarMonth--;
            if (this.currentCalendarMonth < 0) {
                this.currentCalendarMonth = 11;
                this.currentCalendarYear--;
            }
            this.renderCalendar();
        });
        document.getElementById('nextMonth')?.addEventListener('click', () => {
            this.currentCalendarMonth++;
            if (this.currentCalendarMonth > 11) {
                this.currentCalendarMonth = 0;
                this.currentCalendarYear++;
            }
            this.renderCalendar();
        });
        
        // Chat
        document.getElementById('sendMessageBtn')?.addEventListener('click', () => this.sendMessage());
        document.getElementById('chatInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.sendMessage();
            }
        });
        
        // File upload - mostrar archivos seleccionados
        const fileUpload = document.getElementById('fileUpload');
        if (fileUpload) {
            fileUpload.addEventListener('change', (e) => {
                const files = e.target.files;
                const selectedFilesDiv = document.getElementById('selectedFiles');
                if (files && files.length > 0) {
                    const fileNames = Array.from(files).map(f => f.name).join(', ');
                    selectedFilesDiv.textContent = `Archivos seleccionados: ${fileNames}`;
                    selectedFilesDiv.style.color = 'var(--primary-color)';
                    selectedFilesDiv.style.fontWeight = '500';
                } else {
                    selectedFilesDiv.textContent = '';
                }
            });
        }
        
        
        // B√∫squeda y filtros
        this.setupSearchAndFilters();
    },
    
    // Actualizar widgets del dashboard de comercio
    updateComercioWidgets() {
        const userTramites = this.tramites.filter(t => t.comercioId === this.currentUser.email);
        const activos = userTramites.filter(t => t.estado === 'en-proceso' || t.estado === 'pendiente').length;
        const pendientes = userTramites.filter(t => t.estado === 'pendiente').length;
        
        const now = new Date();
        const mesActual = now.getMonth();
        const a√±oActual = now.getFullYear();
        const completadosMes = userTramites.filter(t => {
            if (t.estado === 'completado' && t.historial && t.historial.length > 0) {
                const fechaCompletado = new Date(t.historial[t.historial.length - 1].fecha);
                return fechaCompletado.getMonth() === mesActual && fechaCompletado.getFullYear() === a√±oActual;
            }
            return false;
        }).length;
        
        // Calcular tiempo promedio
        let tiempoPromedio = 0;
        const tramitesCompletados = userTramites.filter(t => t.estado === 'completado' && t.historial && t.historial.length > 0);
        if (tramitesCompletados.length > 0) {
            const tiempos = tramitesCompletados.map(t => {
                const inicio = new Date(t.fechaCreacion);
                const fin = new Date(t.historial[t.historial.length - 1].fecha);
                return (fin - inicio) / (1000 * 60 * 60 * 24); // d√≠as
            });
            tiempoPromedio = Math.round((tiempos.reduce((a, b) => a + b, 0) / tiempos.length) * 10) / 10;
        }
        
        // Actualizar KPI cards
        document.getElementById('kpiTotalActivos').textContent = activos;
        document.getElementById('kpiPendientes').textContent = pendientes;
        document.getElementById('kpiCompletados').textContent = completadosMes;
        document.getElementById('kpiTiempoPromedio').textContent = tiempoPromedio || '0';
        
        // Widget de progreso
        const tramiteReciente = userTramites
            .filter(t => t.estado !== 'completado' && t.estado !== 'rechazado')
            .sort((a, b) => new Date(b.fechaCreacion) - new Date(a.fechaCreacion))[0];
        
        const progresoContainer = document.getElementById('widgetProgresoComercio');
        if (tramiteReciente && tramiteReciente.historial) {
            const completadas = tramiteReciente.historial.filter(h => h.completado).length;
            const total = tramiteReciente.historial.length;
            const porcentaje = Math.round((completadas / total) * 100);
            
            progresoContainer.innerHTML = `
                <div class="progress-widget-content">
                    <div class="progress-widget-item">
                        <h4>${tramiteReciente.id} - ${tramiteReciente.nombreComercio}</h4>
                        <div class="progress-bar-widget">
                            <div class="progress-fill-widget" style="width: ${porcentaje}%"></div>
                        </div>
                        <div class="progress-steps">
                            <span>${completadas} de ${total} etapas</span>
                            <span>${porcentaje}%</span>
                        </div>
                    </div>
                </div>
            `;
        } else {
            progresoContainer.innerHTML = '<p class="widget-empty">No hay tr√°mites activos</p>';
        }
        
        // Widget de notificaciones
        const notificacionesComercio = this.notifications.filter(n => {
            return n.tramiteId && userTramites.some(t => t.id === n.tramiteId);
        }).sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).slice(0, 3);
        
        const notificacionesContainer = document.getElementById('widgetNotificacionesComercio');
        if (notificacionesComercio.length > 0) {
            notificacionesContainer.innerHTML = notificacionesComercio.map(n => {
                const timeAgo = this.getTimeAgo(new Date(n.fecha));
                return `
                    <div class="notification-preview-item ${n.read ? '' : 'unread'}" onclick="AppState.viewTramiteFromNotification('${n.tramiteId}')">
                        <p class="notification-preview-text">${n.message}</p>
                        <span class="notification-preview-time">${timeAgo}</span>
                    </div>
                `;
            }).join('');
        } else {
            notificacionesContainer.innerHTML = '<p class="widget-empty">No hay notificaciones</p>';
        }
    },
    
    // Actualizar widgets del dashboard de inspector
    updateInspectorWidgets() {
        const allTramites = this.tramites;
        const totalAsignados = allTramites.length;
        
        // Calcular urgentes (pendientes por m√°s de 7 d√≠as)
        const hoy = new Date();
        const urgentes = allTramites.filter(t => {
            if (t.estado === 'pendiente' || t.estado === 'en-proceso') {
                const fechaCreacion = new Date(t.fechaCreacion);
                const diasTranscurridos = (hoy - fechaCreacion) / (1000 * 60 * 60 * 24);
                return diasTranscurridos > 7;
            }
            return false;
        });
        
        // Completados hoy
        const completadosHoy = allTramites.filter(t => {
            if (t.estado === 'completado' && t.historial && t.historial.length > 0) {
                const fechaCompletado = new Date(t.historial[t.historial.length - 1].fecha);
                return fechaCompletado.toDateString() === hoy.toDateString();
            }
            return false;
        }).length;
        
        // Tiempo promedio
        let tiempoPromedio = 0;
        const tramitesCompletados = allTramites.filter(t => t.estado === 'completado' && t.historial && t.historial.length > 0);
        if (tramitesCompletados.length > 0) {
            const tiempos = tramitesCompletados.map(t => {
                const inicio = new Date(t.fechaCreacion);
                const fin = new Date(t.historial[t.historial.length - 1].fecha);
                return (fin - inicio) / (1000 * 60 * 60 * 24);
            });
            tiempoPromedio = Math.round((tiempos.reduce((a, b) => a + b, 0) / tiempos.length) * 10) / 10;
        }
        
        // Actualizar KPI cards
        document.getElementById('kpiTotalAsignados').textContent = totalAsignados;
        document.getElementById('kpiUrgentes').textContent = urgentes.length;
        document.getElementById('kpiCompletadosHoy').textContent = completadosHoy;
        document.getElementById('kpiTiempoPromedioInspector').textContent = tiempoPromedio || '0';
        
        // Widget de urgentes
        const urgentesContainer = document.getElementById('widgetUrgentesInspector');
        if (urgentes.length > 0) {
            urgentesContainer.innerHTML = urgentes.slice(0, 5).map(t => {
                const fechaCreacion = new Date(t.fechaCreacion);
                const diasTranscurridos = Math.floor((hoy - fechaCreacion) / (1000 * 60 * 60 * 24));
                return `
                    <div class="urgent-item" onclick="AppState.showTramiteDetail('${t.id}', 'inspector')">
                        <div class="urgent-item-header">
                            <span class="urgent-item-id">${t.id}</span>
                            <span class="urgent-item-days">${diasTranscurridos} d√≠as</span>
                        </div>
                        <p class="urgent-item-name">${t.nombreComercio}</p>
                    </div>
                `;
            }).join('');
        } else {
            urgentesContainer.innerHTML = '<p class="widget-empty">No hay tr√°mites urgentes</p>';
        }
        
        // Widget de actividad del d√≠a
        const actividadContainer = document.getElementById('widgetActividadInspector');
        const actividadesHoy = allTramites.filter(t => {
            return t.historial.some(h => {
                if (h.fecha) {
                    const fecha = new Date(h.fecha);
                    return fecha.toDateString() === hoy.toDateString();
                }
                return false;
            });
        });
        
        if (actividadesHoy.length > 0) {
            actividadContainer.innerHTML = actividadesHoy.slice(0, 5).map(t => {
                const actividadHoy = t.historial.find(h => {
                    if (h.fecha) {
                        const fecha = new Date(h.fecha);
                        return fecha.toDateString() === hoy.toDateString();
                    }
                    return false;
                });
                const hora = actividadHoy ? new Date(actividadHoy.fecha).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : '';
                return `
                    <div class="activity-item-preview">
                        <div class="activity-item-time">${hora}</div>
                        <p class="activity-item-text">${t.id} - ${actividadHoy?.etapa || 'Actividad'}</p>
                    </div>
                `;
            }).join('');
        } else {
            actividadContainer.innerHTML = '<p class="widget-empty">No hay actividades programadas</p>';
        }
    },
    
    // ========== MEJORAS DE ALTA PRIORIDAD ==========
    
    // 1. B√öSQUEDA GLOBAL
    showGlobalSearch() {
        const modal = document.getElementById('globalSearchModal');
        const input = document.getElementById('globalSearchInput');
        if (modal && input) {
            modal.classList.add('active');
            input.focus();
            input.addEventListener('input', (e) => this.performGlobalSearch(e.target.value));
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && this.globalSearchResults.length > 0) {
                    this.globalSearchResults[0].onClick();
                }
            });
        }
    },
    
    performGlobalSearch(query) {
        if (!query || query.length < 2) {
            document.getElementById('globalSearchResults').innerHTML = '<p class="search-placeholder">Escribe para buscar...</p>';
            return;
        }
        
        const results = [];
        const searchTerm = query.toLowerCase();
        
        // Buscar en tr√°mites
        const tramites = this.currentUser?.tipo === 'inspector' 
            ? this.tramites 
            : this.tramites.filter(t => t.comercioId === this.currentUser?.email);
        
        tramites.forEach(tramite => {
            const matches = [];
            if (tramite.id.toLowerCase().includes(searchTerm)) matches.push('ID');
            if (tramite.nombreComercio.toLowerCase().includes(searchTerm)) matches.push('Nombre');
            if (tramite.direccion.toLowerCase().includes(searchTerm)) matches.push('Direcci√≥n');
            if (tramite.tipoComercio.toLowerCase().includes(searchTerm)) matches.push('Tipo');
            
            if (matches.length > 0) {
                results.push({
                    type: 'tramite',
                    title: `${tramite.id} - ${tramite.nombreComercio}`,
                    subtitle: `${tramite.direccion} ‚Ä¢ ${this.getEstadoLabel(tramite.estado)}`,
                    matches: matches.join(', '),
                    onClick: () => {
                        document.getElementById('globalSearchModal').classList.remove('active');
                        this.showTramiteDetail(tramite.id, this.currentUser?.tipo);
                    }
                });
            }
        });
        
        // Buscar en notificaciones
        this.notifications.forEach(notif => {
            if (notif.message.toLowerCase().includes(searchTerm)) {
                results.push({
                    type: 'notification',
                    title: notif.message,
                    subtitle: new Date(notif.fecha).toLocaleDateString('es-ES'),
                    onClick: () => {
                        document.getElementById('globalSearchModal').classList.remove('active');
                        if (notif.tramiteId) {
                            this.showTramiteDetail(notif.tramiteId, this.currentUser?.tipo);
                        } else {
                            this.navigateToSection(this.currentUser?.tipo === 'comercio' ? 'notificationsSectionComercio' : 'notificationsSectionInspector');
                        }
                    }
                });
            }
        });
        
        this.globalSearchResults = results;
        this.renderGlobalSearchResults(results);
    },
    
    renderGlobalSearchResults(results) {
        const container = document.getElementById('globalSearchResults');
        if (!container) return;
        
        if (results.length === 0) {
            container.innerHTML = '<p class="search-placeholder">No se encontraron resultados</p>';
            return;
        }
        
        container.innerHTML = results.map((result, index) => `
            <div class="global-search-result" onclick="(${result.onClick.toString()})()" style="cursor: pointer;">
                <div class="search-result-icon">${result.type === 'tramite' ? 'üìã' : 'üîî'}</div>
                <div class="search-result-content">
                    <div class="search-result-title">${result.title}</div>
                    <div class="search-result-subtitle">${result.subtitle}</div>
                    ${result.matches ? `<div class="search-result-matches">Coincide en: ${result.matches}</div>` : ''}
                </div>
            </div>
        `).join('');
    },
    
    // 2. FILTROS GUARDADOS
    loadSavedFilters() {
        const saved = localStorage.getItem('savedFilters');
        if (saved) {
            this.savedFilters = JSON.parse(saved);
        }
    },
    
    saveFilters() {
        localStorage.setItem('savedFilters', JSON.stringify(this.savedFilters));
    },
    
    saveCurrentFilters(name) {
        if (!name) {
            this.showNotification('Por favor ingresa un nombre para el filtro', 'warning');
            return;
        }
        
        const filters = {
            name,
            tipoComercio: document.getElementById('advancedFilterTipoComercio')?.value || '',
            fechaDesde: document.getElementById('advancedFilterFechaDesde')?.value || '',
            fechaHasta: document.getElementById('advancedFilterFechaHasta')?.value || '',
            progreso: document.getElementById('advancedFilterProgreso')?.value || '',
            estado: document.getElementById('filterEstadoComercio')?.value || document.getElementById('filterEstadoInspector')?.value || 'all',
            sortBy: document.getElementById('sortByComercio')?.value || document.getElementById('sortByInspector')?.value || 'fecha-desc',
            fecha: new Date().toISOString()
        };
        
        this.savedFilters.push(filters);
        this.saveFilters();
        this.showNotification(`Filtro "${name}" guardado`, 'success');
        
        const type = this.currentUser?.tipo === 'comercio' ? 'comercio' : 'inspector';
        this.renderSavedFilters(type);
        
        // Limpiar input
        const input = document.getElementById(`saveFilterName${type === 'comercio' ? 'Comercio' : 'Inspector'}`);
        if (input) input.value = '';
    },
    
    applySavedFilter(filter) {
        if (filter.tipoComercio) document.getElementById('advancedFilterTipoComercio').value = filter.tipoComercio;
        if (filter.fechaDesde) document.getElementById('advancedFilterFechaDesde').value = filter.fechaDesde;
        if (filter.fechaHasta) document.getElementById('advancedFilterFechaHasta').value = filter.fechaHasta;
        if (filter.progreso) document.getElementById('advancedFilterProgreso').value = filter.progreso;
        if (filter.estado) {
            const estadoFilter = document.getElementById('filterEstadoComercio') || document.getElementById('filterEstadoInspector');
            if (estadoFilter) estadoFilter.value = filter.estado;
        }
        if (filter.sortBy) {
            const sortBy = document.getElementById('sortByComercio') || document.getElementById('sortByInspector');
            if (sortBy) sortBy.value = filter.sortBy;
        }
        
        this.advancedFilters = {
            tipoComercio: filter.tipoComercio,
            fechaDesde: filter.fechaDesde,
            fechaHasta: filter.fechaHasta,
            progreso: filter.progreso
        };
        
        const type = this.currentUser?.tipo === 'comercio' ? 'comercio' : 'inspector';
        this.applyAdvancedSearch(type);
    },
    
    deleteSavedFilter(index) {
        this.savedFilters.splice(index, 1);
        this.saveFilters();
        this.showNotification('Filtro eliminado', 'info');
        const type = this.currentUser?.tipo === 'comercio' ? 'comercio' : 'inspector';
        this.renderSavedFilters(type);
    },
    
    // 3. BREADCRUMBS
    renderBreadcrumbs(paths) {
        const breadcrumbs = paths.map((path, index) => {
            if (index === paths.length - 1) {
                return `<span class="current">${path.name}</span>`;
            }
            return `<a href="#" onclick="AppState.navigateToSection('${path.section}'); return false;">${path.name}</a> <span>/</span>`;
        }).join(' ');
        
        return `<div class="breadcrumbs">${breadcrumbs}</div>`;
    },
    
    updateBreadcrumbs() {
        const activeScreen = document.querySelector('.screen.active');
        if (!activeScreen) return;
        
        const screenId = activeScreen.id;
        let paths = [{ name: 'Inicio', section: this.currentUser?.tipo === 'comercio' ? 'comercioDashboard' : 'inspectorDashboard' }];
        
        const breadcrumbMap = {
            'notificationsSectionComercio': { name: 'Notificaciones', section: 'notificationsSectionComercio' },
            'notificationsSectionInspector': { name: 'Notificaciones', section: 'notificationsSectionInspector' },
            'profileSectionComercio': { name: 'Mi Perfil', section: 'profileSectionComercio' },
            'profileSectionInspector': { name: 'Mi Perfil', section: 'profileSectionInspector' },
            'statsSectionInspector': { name: 'Estad√≠sticas', section: 'statsSectionInspector' },
            'calendarSectionInspector': { name: 'Calendario', section: 'calendarSectionInspector' }
        };
        
        if (breadcrumbMap[screenId]) {
            paths.push(breadcrumbMap[screenId]);
        }
        
        const container = document.querySelector('.main-content .container');
        if (container) {
            const existingBreadcrumbs = container.querySelector('.breadcrumbs');
            if (existingBreadcrumbs) {
                existingBreadcrumbs.outerHTML = this.renderBreadcrumbs(paths);
            } else {
                container.insertAdjacentHTML('afterbegin', this.renderBreadcrumbs(paths));
            }
        }
    },
    
    // 4. SERVICE WORKER (PWA)
    initServiceWorker() {
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => {
                        console.log('Service Worker registrado:', reg);
                    })
                    .catch(err => {
                        console.log('Error al registrar Service Worker:', err);
                    });
            });
        }
    },
    
    // 5. NOTIFICACIONES PUSH
    initPushNotifications() {
        if ('Notification' in window && 'serviceWorker' in navigator) {
            if (Notification.permission === 'default') {
                // Solicitar permiso despu√©s de un tiempo
                setTimeout(() => {
                    this.requestNotificationPermission();
                }, 3000);
            }
        }
    },
    
    requestNotificationPermission() {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                this.showNotification('Notificaciones activadas', 'success');
            }
        });
    },
    
    showPushNotification(title, options = {}) {
        if ('Notification' in window && Notification.permission === 'granted') {
            const notification = new Notification(title, {
                body: options.body || '',
                icon: options.icon || 'Aesali.png',
                badge: 'Aesali.png',
                tag: options.tag || 'default',
                requireInteraction: options.requireInteraction || false,
                ...options
            });
            
            notification.onclick = () => {
                window.focus();
                if (options.onClick) options.onClick();
                notification.close();
            };
            
            setTimeout(() => notification.close(), options.duration || 5000);
        }
    },
    
    // ========== CHATBOT ==========
    initChatbot() {
        const toggle = document.getElementById('chatbotToggle');
        const close = document.getElementById('chatbotClose');
        const window = document.getElementById('chatbotWindow');
        const input = document.getElementById('chatbotInput');
        const sendBtn = document.getElementById('chatbotSend');
        const quickQuestions = document.querySelectorAll('.quick-question-btn');
        const container = document.getElementById('chatbotContainer');
        
        // Toggle chatbot
        toggle?.addEventListener('click', () => {
            window.classList.toggle('active');
            if (window.classList.contains('active')) {
                input.focus();
                this.hideChatbotBadge();
            }
        });
        
        // Cerrar chatbot
        close?.addEventListener('click', () => {
            window.classList.remove('active');
        });
        
        // Enviar mensaje con Enter
        input?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && input.value.trim()) {
                this.sendChatbotMessage(input.value.trim());
                input.value = '';
            }
        });
        
        // Enviar mensaje con bot√≥n
        sendBtn?.addEventListener('click', () => {
            if (input.value.trim()) {
                this.sendChatbotMessage(input.value.trim());
                input.value = '';
            }
        });
        
        // Preguntas r√°pidas
        quickQuestions.forEach(btn => {
            btn.addEventListener('click', () => {
                const question = btn.dataset.question;
                this.sendChatbotMessage(question);
            });
        });
        
        // Actualizar visibilidad del chatbot seg√∫n la pantalla activa
        this.updateChatbotVisibility();
    },
    
    updateChatbotVisibility() {
        const container = document.getElementById('chatbotContainer');
        if (!container) return;
        
        const activeScreen = document.querySelector('.screen.active');
        if (!activeScreen) {
            container.style.display = 'none';
            return;
        }
        
        const screenId = activeScreen.id;
        const isLoggedIn = this.currentUser !== null;
        const isWelcomeOrLogin = screenId === 'welcomeScreen' || screenId === 'loginScreen';
        
        // Mostrar solo si est√° logueado y no est√° en welcome/login
        if (isLoggedIn && !isWelcomeOrLogin) {
            container.style.display = 'block';
            // Mostrar badge inicial despu√©s de 3 segundos si el chat no est√° abierto
            setTimeout(() => {
                const window = document.getElementById('chatbotWindow');
                if (window && !window.classList.contains('active')) {
                    this.showChatbotBadge();
                }
            }, 3000);
        } else {
            container.style.display = 'none';
            // Cerrar ventana si est√° abierta
            const window = document.getElementById('chatbotWindow');
            if (window) {
                window.classList.remove('active');
            }
        }
        
        // Actualizar tambi√©n el footer
        this.updateFooterVisibility();
    },
    
    updateFooterVisibility() {
        const footer = document.getElementById('appFooter');
        if (!footer) return;
        
        const activeScreen = document.querySelector('.screen.active');
        if (!activeScreen) {
            footer.style.display = 'none';
            return;
        }
        
        const screenId = activeScreen.id;
        const isLoggedIn = this.currentUser !== null;
        const isWelcomeOrLogin = screenId === 'welcomeScreen' || screenId === 'loginScreen';
        
        // Mostrar footer solo si est√° logueado y no est√° en welcome/login
        if (isLoggedIn && !isWelcomeOrLogin) {
            footer.style.display = 'block';
        } else {
            footer.style.display = 'none';
        }
    },
    
    showChatbotBadge() {
        const badge = document.getElementById('chatbotBadge');
        if (badge) {
            badge.classList.add('show');
        }
    },
    
    hideChatbotBadge() {
        const badge = document.getElementById('chatbotBadge');
        if (badge) {
            badge.classList.remove('show');
        }
    },
    
    sendChatbotMessage(message) {
        const messagesContainer = document.getElementById('chatbotMessages');
        const input = document.getElementById('chatbotInput');
        if (!messagesContainer || !input) return;
        
        // Limpiar mensaje de bienvenida inicial si existe
        const welcomeMessage = messagesContainer.querySelector('.welcome-message');
        if (welcomeMessage) {
            welcomeMessage.remove();
        }
        
        // Agregar mensaje del usuario
        const userMessage = document.createElement('div');
        userMessage.className = 'chatbot-message user-message';
        userMessage.innerHTML = `
            <div class="message-avatar">üë§</div>
            <div class="message-content">
                <p>${this.escapeHtml(message)}</p>
                <span class="message-time">${new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</span>
            </div>
        `;
        messagesContainer.appendChild(userMessage);
        
        // Scroll al final
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Mostrar indicador de escritura
        this.showTypingIndicator();
        
        // Responder despu√©s de un breve delay (simulando procesamiento)
        const delay = Math.random() * 500 + 800; // Entre 800ms y 1300ms
        setTimeout(() => {
            this.hideTypingIndicator();
            this.getChatbotResponse(message);
        }, delay);
    },
    
    showTypingIndicator() {
        const messagesContainer = document.getElementById('chatbotMessages');
        if (!messagesContainer) return;
        
        // Remover indicador anterior si existe
        const existing = messagesContainer.querySelector('.typing-indicator');
        if (existing) existing.remove();
        
        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'chatbot-message bot-message typing-indicator';
        typingIndicator.innerHTML = `
            <div class="message-avatar">ü§ñ</div>
            <div class="message-content">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        `;
        messagesContainer.appendChild(typingIndicator);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    },
    
    hideTypingIndicator() {
        const messagesContainer = document.getElementById('chatbotMessages');
        if (!messagesContainer) return;
        
        const typingIndicator = messagesContainer.querySelector('.typing-indicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    },
    
    getChatbotResponse(message) {
        const messagesContainer = document.getElementById('chatbotMessages');
        if (!messagesContainer) return;
        
        const query = message.toLowerCase();
        let response = '';
        let actions = null;
        
        // Obtener informaci√≥n del usuario actual
        const userType = this.currentUser?.tipo;
        const tramitesCount = this.tramites?.filter(t => 
            userType === 'comercio' ? t.comercioId === this.currentUser?.email : true
        ).length || 0;
        
        // Base de conocimiento mejorada con respuestas contextuales
        if (query.includes('nuevo tr√°mite') || query.includes('crear tr√°mite') || query.includes('solicitar tr√°mite')) {
            if (userType === 'comercio') {
                response = `Para crear un nuevo tr√°mite:\n\n1Ô∏è‚É£ Haz clic en el bot√≥n "Nuevo Tr√°mite" en tu dashboard\n2Ô∏è‚É£ Completa el formulario con:\n   ‚Ä¢ Nombre del comercio\n   ‚Ä¢ Direcci√≥n completa\n   ‚Ä¢ Tipo de comercio\n   ‚Ä¢ Tel√©fono de contacto\n\n3Ô∏è‚É£ Revisa y env√≠a la solicitud\n\n¬øQuieres que te ayude a crear uno ahora?`;
                actions = [{ text: this.t('newTramite'), action: 'createTramite' }];
            } else {
                response = 'Solo los comercios pueden crear nuevos tr√°mites. Como inspector, puedes revisar y gestionar los tr√°mites asignados desde tu dashboard.';
            }
        } else if (query.includes('mis tr√°mites') || query.includes('listar tr√°mites') || query.includes('ver tr√°mites')) {
            if (userType === 'comercio') {
                const activos = this.tramites?.filter(t => 
                    t.comercioId === this.currentUser?.email && 
                    (t.estado === 'pendiente' || t.estado === 'en-proceso')
                ).length || 0;
                response = `Tienes ${tramitesCount} tr√°mite${tramitesCount !== 1 ? 's' : ''} en total.\n\nüìä ${activos} ${activos === 1 ? 'est√°' : 'est√°n'} activo${activos !== 1 ? 's' : ''} (pendiente o en proceso)\n\n¬øQuieres ver el detalle de alg√∫n tr√°mite espec√≠fico?`;
                if (tramitesCount > 0) {
                    actions = [{ text: 'Ver todos los tr√°mites', action: 'viewTramites' }];
                }
            } else {
                const asignados = this.tramites?.filter(t => t.estado !== 'completado').length || 0;
                response = `Tienes ${asignados} tr√°mite${asignados !== 1 ? 's' : ''} asignado${asignados !== 1 ? 's' : ''} para revisar.\n\nPuedes verlos y gestionarlos desde tu dashboard principal.`;
            }
        } else if (query.includes('subir documento') || query.includes('cargar documento') || query.includes('documento')) {
            response = `Para subir documentos:\n\n1Ô∏è‚É£ Abre el detalle del tr√°mite que necesitas\n2Ô∏è‚É£ Haz clic en la pesta√±a "Documentos"\n3Ô∏è‚É£ Selecciona el documento requerido\n4Ô∏è‚É£ Sube el archivo (PDF, JPG, PNG, DOC, DOCX)\n5Ô∏è‚É£ Espera la confirmaci√≥n\n\nüìã Formatos aceptados: PDF, JPG, PNG, DOC, DOCX\nüìè Tama√±o m√°ximo: 10 MB por archivo\n\n¬øNecesitas ayuda con alg√∫n documento espec√≠fico?`;
            actions = [{ text: 'Ver mis tr√°mites', action: 'viewTramites' }];
        } else if (query.includes('documento requerido') || query.includes('qu√© documento') || query.includes('necesito')) {
            response = `Los documentos requeridos dependen del tipo de comercio:\n\nüìÑ Documentos generales:\n‚Ä¢ Certificado de C√°mara de Comercio\n‚Ä¢ RUT (Registro √önico Tributario)\n‚Ä¢ Concepto de Uso de Suelo\n\nüè™ Documentos espec√≠ficos:\n‚Ä¢ Certificado de Fumigaci√≥n\n‚Ä¢ An√°lisis de Agua Potable\n‚Ä¢ Licencia de Funcionamiento (si aplica)\n‚Ä¢ Permisos de salud y seguridad\n\nRevisa la lista completa en la secci√≥n de documentos de cada tr√°mite.`;
        } else if (query.includes('estado') || query.includes('progreso') || query.includes('avance')) {
            if (tramitesCount > 0) {
                const estados = this.tramites?.filter(t => 
                    userType === 'comercio' ? t.comercioId === this.currentUser?.email : true
                ).reduce((acc, t) => {
                    acc[t.estado] = (acc[t.estado] || 0) + 1;
                    return acc;
                }, {}) || {};
                
                response = `Estado de tus tr√°mites:\n\n`;
                if (estados.pendiente) response += `‚è≥ Pendientes: ${estados.pendiente}\n`;
                if (estados['en-proceso']) response += `üîÑ En proceso: ${estados['en-proceso']}\n`;
                if (estados.completado) response += `‚úÖ Completados: ${estados.completado}\n`;
                if (estados.rechazado) response += `‚ùå Rechazados: ${estados.rechazado}\n`;
                
                response += `\nHaz clic en cualquier tr√°mite para ver el progreso detallado con todas las etapas.`;
                actions = [{ text: 'Ver mis tr√°mites', action: 'viewTramites' }];
            } else {
                response = 'Para ver el estado de tu tr√°mite, haz clic en cualquier tr√°mite de tu lista. Ver√°s el progreso completo con todas las etapas desde la notificaci√≥n inicial hasta la emisi√≥n del concepto sanitario.';
            }
        } else if (query.includes('tiempo') || query.includes('cu√°nto') || query.includes('d√≠as')) {
            const tiempoPromedio = '15-30 d√≠as h√°biles';
            response = `‚è±Ô∏è Tiempo de procesamiento:\n\n‚Ä¢ Tiempo promedio: ${tiempoPromedio}\n‚Ä¢ Depende de:\n  - Complejidad del tr√°mite\n  - Disponibilidad del inspector\n  - Completitud de documentos\n\nüí° Consejo: Sube todos los documentos requeridos lo antes posible para acelerar el proceso.`;
        } else if (query.includes('notificaci√≥n') || query.includes('alerta') || query.includes('aviso')) {
            const notifCount = this.notifications?.filter(n => !n.read).length || 0;
            response = `üîî Notificaciones:\n\nRecibir√°s notificaciones autom√°ticas cuando:\n‚Ä¢ Se complete una etapa\n‚Ä¢ Se apruebe o rechace un documento\n‚Ä¢ Se programe una visita\n‚Ä¢ Se emita el concepto sanitario\n\n${notifCount > 0 ? `Tienes ${notifCount} notificaci√≥n${notifCount !== 1 ? 'es' : ''} sin leer.` : 'No tienes notificaciones nuevas.'}\n\nRevisa tu bandeja en el icono de notificaciones del header.`;
            if (notifCount > 0) {
                actions = [{ text: 'Ver notificaciones', action: 'viewNotifications' }];
            }
        } else if (query.includes('visita') || query.includes('inspecci√≥n')) {
            response = `üè¢ Visitas de inspecci√≥n:\n\n‚Ä¢ Son programadas por el inspector sanitario\n‚Ä¢ Recibir√°s una notificaci√≥n cuando se programe\n‚Ä¢ En el detalle del tr√°mite ver√°s la fecha y hora\n‚Ä¢ Prep√°rate con todos los documentos listos\n\nüí° Tip: Revisa tu calendario de actividades para ver las visitas programadas.`;
            if (userType === 'inspector') {
                actions = [{ text: 'Ver calendario', action: 'viewCalendar' }];
            }
        } else if (query.includes('concepto') || query.includes('resultado') || query.includes('aprobado')) {
            response = `üìã Concepto sanitario:\n\nPuede ser:\n\n‚úÖ Favorable: Todo en orden, puedes operar\n‚ö†Ô∏è Favorable con Requerimientos: Necesitas hacer correcciones\n‚ùå Desfavorable: No se cumplen las condiciones\n\nSe emite al finalizar todas las etapas del tr√°mite.`;
        } else if (query.includes('contacto') || query.includes('ayuda') || query.includes('soporte')) {
            response = `üí¨ Soporte:\n\nPara ayuda adicional:\n‚Ä¢ Revisa las notificaciones del sistema\n‚Ä¢ Consulta la documentaci√≥n en cada etapa\n‚Ä¢ Contacta al inspector asignado a tu tr√°mite\n‚Ä¢ Tel√©fono: +57 310 356 1871\n\n¬øHay algo espec√≠fico en lo que pueda ayudarte?`;
        } else if (query.includes('hola') || query.includes('buenos d√≠as') || query.includes('buenas tardes') || query.includes('hi') || query.includes('hello')) {
            const hora = new Date().getHours();
            let saludo = '¬°Hola!';
            if (hora < 12) saludo = '¬°Buenos d√≠as!';
            else if (hora < 19) saludo = '¬°Buenas tardes!';
            else saludo = '¬°Buenas noches!';
            
            response = `${saludo} Soy tu asistente virtual de Aeternum Salubris.\n\nPuedo ayudarte con:\n‚Ä¢ Creaci√≥n de tr√°mites\n‚Ä¢ Subida de documentos\n‚Ä¢ Estado de tr√°mites\n‚Ä¢ Tiempos de procesamiento\n‚Ä¢ Notificaciones\n‚Ä¢ Visitas de inspecci√≥n\n‚Ä¢ Conceptos sanitarios\n\n¬øEn qu√© puedo ayudarte hoy?`;
        } else if (query.includes('gracias') || query.includes('thank')) {
            response = '¬°De nada! üòä Si tienes m√°s preguntas, no dudes en preguntarme. Estoy aqu√≠ para ayudarte.';
        } else if (query.includes('adi√≥s') || query.includes('bye') || query.includes('hasta luego')) {
            response = '¬°Hasta luego! Que tengas un excelente d√≠a. Si necesitas algo m√°s, estar√© aqu√≠. üëã';
        } else {
            // Respuesta inteligente con sugerencias
            response = `Entiendo tu pregunta. Puedo ayudarte con:\n\nüìù Creaci√≥n de tr√°mites\nüìÑ Subida de documentos\nüìä Estado de tr√°mites\n‚è±Ô∏è Tiempos de procesamiento\nüîî Notificaciones\nüè¢ Visitas de inspecci√≥n\nüìã Conceptos sanitarios\n\n¬øSobre cu√°l de estos temas quieres saber m√°s?`;
            actions = [
                { text: 'Ver mis tr√°mites', action: 'viewTramites' },
                { text: 'Crear tr√°mite', action: 'createTramite' }
            ];
        }
        
        // Agregar respuesta del bot
        const botMessage = document.createElement('div');
        botMessage.className = 'chatbot-message bot-message';
        
        let actionsHtml = '';
        if (actions && actions.length > 0) {
            actionsHtml = '<div class="chatbot-actions">' + 
                actions.map(action => 
                    `<button class="chatbot-action-btn" data-action="${action.action}">${action.text}</button>`
                ).join('') + 
                '</div>';
        }
        
        botMessage.innerHTML = `
            <div class="message-avatar">ü§ñ</div>
            <div class="message-content">
                <p>${response.replace(/\n/g, '<br>')}</p>
                ${actionsHtml}
                <span class="message-time">${new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</span>
            </div>
        `;
        messagesContainer.appendChild(botMessage);
        
        // Agregar event listeners a los botones de acci√≥n
        botMessage.querySelectorAll('.chatbot-action-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const action = btn.dataset.action;
                this.handleChatbotAction(action);
            });
        });
        
        // Scroll al final
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    },
    
    handleChatbotAction(action) {
        switch(action) {
            case 'createTramite':
                if (this.currentUser?.tipo === 'comercio') {
                    document.getElementById('nuevoTramiteBtn')?.click();
                }
                break;
            case 'viewTramites':
                this.navigateToSection(this.currentUser?.tipo === 'comercio' ? 'comercioDashboard' : 'inspectorDashboard');
                break;
            case 'viewNotifications':
                const notifBtn = document.getElementById('notificationsBtn') || document.getElementById('notificationsBtnInspector');
                notifBtn?.click();
                break;
            case 'viewCalendar':
                if (this.currentUser?.tipo === 'inspector') {
                    this.navigateToSection('calendarSectionInspector');
                }
                break;
        }
    },
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
};

// Inicializar aplicaci√≥n cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', () => {
    AppState.init();
});

// Agregar estilos de animaci√≥n para notificaciones
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);

